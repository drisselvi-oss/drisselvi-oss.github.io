<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Budget Annuel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
  --bg-primary:#F4F1EC;--bg-secondary:#FFF;--bg-card:#FFF;
  --text-primary:#2C2C2C;--text-secondary:#6B6B6B;--text-muted:#9E9E9E;
  --accent:#C8956C;--accent-light:#E8D5C4;--accent-dark:#A07050;
  --green:#5A9A6E;--green-bg:#EAF4EC;
  --red:#C75B5B;--red-bg:#FAEAEA;
  --blue:#5B7FC7;--blue-bg:#EAF0FA;
  --border:#E5E0D8;--shadow:0 2px 12px rgba(0,0,0,.06);--shadow-lg:0 8px 30px rgba(0,0,0,.08);
  --radius:14px;
  --annual-badge:#8B6DC7;--annual-badge-bg:#F0EAFA;
  --savings:#2E8B8B;--savings-bg:#E4F5F3;--savings-light:#D0EDEB;
  --input-bg:#FAF8F5;
  --orange:#D48A3E;--orange-bg:#FDF3E6;
  --recap:#3B7DD8;--recap-bg:#E8F0FC;
  --carryover:#8B8B5A;--carryover-bg:#F5F5E8;
}
html.dark {
  --bg-primary:#1A1A1F;--bg-secondary:#222228;--bg-card:#2A2A32;
  --text-primary:#E8E4DF;--text-secondary:#A09A90;--text-muted:#6E6A62;
  --accent:#D4A06A;--accent-light:#3D3228;--accent-dark:#E8B880;
  --green:#6EBD84;--green-bg:#1E2E22;
  --red:#E07070;--red-bg:#2E1E1E;
  --blue:#7094DD;--blue-bg:#1E2436;
  --border:#3A3A42;--shadow:0 2px 12px rgba(0,0,0,.2);--shadow-lg:0 8px 30px rgba(0,0,0,.3);
  --annual-badge:#A88AE0;--annual-badge-bg:#2A2440;
  --savings:#4EC4C4;--savings-bg:#1E2E2E;--savings-light:#253838;
  --input-bg:#24242C;
  --orange:#E8A54C;--orange-bg:#2E2618;
  --recap:#5A9AEE;--recap-bg:#1E2840;
  --carryover:#BABA70;--carryover-bg:#2E2E1E;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
.app-header{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:16px 20px 0;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#FFF;font-size:18px}
.logo h1{font-family:'DM Serif Display',serif;font-size:22px;font-weight:400;color:var(--text-primary)}
.header-actions{display:flex;gap:8px}
.btn-icon{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .2s}
.btn-icon:hover{border-color:var(--accent);color:var(--accent)}
.tabs-container{display:flex;gap:4px;overflow-x:auto;padding-bottom:0;scrollbar-width:none;-ms-overflow-style:none}
.tabs-container::-webkit-scrollbar{display:none}
.tab-btn{padding:8px 14px;border-radius:10px 10px 0 0;border:none;background:transparent;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--text-muted);cursor:pointer;white-space:nowrap;transition:all .25s}
.tab-btn:hover{color:var(--text-secondary);background:var(--bg-primary)}
.tab-btn.active{background:var(--accent);color:#FFF}
.tab-btn.annual-tab{color:var(--annual-badge)}.tab-btn.annual-tab.active{background:var(--annual-badge);color:#FFF}
.tab-btn.savings-tab{color:var(--savings)}.tab-btn.savings-tab.active{background:var(--savings);color:#FFF}
.tab-btn.recap-tab{color:var(--recap)}.tab-btn.recap-tab.active{background:var(--recap);color:#FFF}
.tab-btn .tab-balance{display:block;font-size:10px;font-weight:600;margin-top:1px}
.tab-btn .tab-balance.positive{color:var(--green)}.tab-btn .tab-balance.negative{color:var(--red)}
.tab-btn.active .tab-balance.positive,.tab-btn.active .tab-balance.negative{color:rgba(255,255,255,.85)}
.main-content{max-width:820px;margin:0 auto;padding:20px 16px 100px}
/* Summary */
.summary-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:20px}
.summary-card{background:var(--bg-card);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);border:1px solid var(--border)}
.summary-card .label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);margin-bottom:4px}
.summary-card .value{font-family:'DM Serif Display',serif;font-size:20px;color:var(--text-primary)}
.summary-card.income .value{color:var(--green)}
.summary-card.expense .value{color:var(--red)}
.summary-card.balance .value.positive{color:var(--green)}.summary-card.balance .value.negative{color:var(--red)}
.summary-card.savings-card .value{color:var(--savings)}
.balance-bar{height:6px;border-radius:3px;background:var(--border);margin-top:6px;overflow:hidden}
.balance-bar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.balance-bar-fill.positive{background:var(--green)}.balance-bar-fill.negative{background:var(--red)}
/* Sections */
.section{background:var(--bg-card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:16px;overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.section-title{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:800;color:var(--text-primary)}
.section-title .icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px}
.section-title .icon.income-icon{background:var(--green-bg);color:var(--green)}
.section-title .icon.expense-icon{background:var(--red-bg);color:var(--red)}
.section-title .icon.annual-icon{background:var(--annual-badge-bg);color:var(--annual-badge)}
.section-title .icon.savings-icon{background:var(--savings-bg);color:var(--savings)}
.section-title .icon.provision-icon{background:var(--blue-bg);color:var(--blue)}
.section-title .icon.variable-icon{background:var(--orange-bg);color:var(--orange)}
.section-title .icon.recap-icon{background:var(--recap-bg);color:var(--recap)}
.section-title .icon.carryover-icon{background:var(--carryover-bg);color:var(--carryover)}
.section-total{font-family:'DM Serif Display',serif;font-size:18px}
.section-total.income-total{color:var(--green)}.section-total.expense-total{color:var(--red)}
.section-total.annual-total{color:var(--annual-badge)}.section-total.savings-total{color:var(--savings)}
.section-total.provision-total{color:var(--blue)}.section-total.variable-total{color:var(--orange)}
.section-total.recap-total{color:var(--recap)}
.auto-badge{display:inline-flex;align-items:center;gap:4px;background:var(--annual-badge-bg);color:var(--annual-badge);padding:2px 8px;border-radius:6px;font-size:10px;font-weight:800;margin-left:6px;letter-spacing:.5px}
.provision-badge{display:inline-flex;align-items:center;gap:4px;background:var(--blue-bg);color:var(--blue);padding:2px 8px;border-radius:6px;font-size:10px;font-weight:800;margin-left:6px;letter-spacing:.5px}
.carryover-badge{display:inline-flex;align-items:center;gap:4px;background:var(--carryover-bg);color:var(--carryover);padding:2px 8px;border-radius:6px;font-size:10px;font-weight:800;margin-left:6px;letter-spacing:.5px}
/* Rows */
.budget-row{display:grid;grid-template-columns:28px 1fr 130px 32px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);transition:background .15s;gap:4px}
.budget-row:last-child{border-bottom:none}
.budget-row:hover{background:var(--input-bg)}
.budget-row.auto-row{background:var(--annual-badge-bg);cursor:default;grid-template-columns:1fr 130px 32px}
.budget-row.auto-row:hover{background:var(--annual-badge-bg)}
.budget-row.provision-row{background:var(--blue-bg);cursor:default;grid-template-columns:1fr 130px 32px}
.budget-row.provision-row:hover{background:var(--blue-bg)}
.budget-row.provision-row .auto-value{color:var(--blue)}
.budget-row.carryover-row{background:var(--carryover-bg);cursor:default;grid-template-columns:1fr 130px}
.budget-row.carryover-row:hover{background:var(--carryover-bg)}
.provision-detail-label{display:flex;flex-direction:column;gap:1px}
.provision-detail-label .prov-name{font-size:14px;font-weight:600;color:var(--text-primary)}
.provision-detail-label .prov-meta{font-size:11px;color:var(--text-muted);font-weight:600}
/* Variable row */
.var-row{display:grid;grid-template-columns:28px 1fr 100px 100px 32px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);transition:background .15s;gap:4px}
.var-row:last-child{border-bottom:none}
.var-row:hover{background:var(--input-bg)}
.var-col-headers{display:grid;grid-template-columns:28px 1fr 100px 100px 32px;padding:4px 14px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);gap:4px;border-bottom:1px solid var(--border)}
.var-col-headers span:nth-child(3){text-align:right}.var-col-headers span:nth-child(4){text-align:right}
/* Move buttons */
.move-btns{display:flex;flex-direction:column;gap:1px;align-items:center}
.move-btn{width:22px;height:14px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:9px;border-radius:3px;display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0}
.move-btn:hover{background:var(--border);color:var(--text-primary)}
/* Row elements */
.row-label{font-size:14px;font-weight:600;color:var(--text-primary)}
.row-label input{border:none;background:transparent;font-family:'Nunito',sans-serif;font-size:14px;font-weight:600;color:var(--text-primary);width:100%;outline:none}
.row-label input::placeholder{color:var(--text-muted)}
.row-label input:focus{border-bottom:2px solid var(--accent)}
.row-amount input{border:none;background:var(--input-bg);border-radius:8px;padding:7px 10px;font-family:'Nunito',sans-serif;font-size:16px;font-weight:700;color:var(--text-primary);width:100%;text-align:right;outline:none;transition:all .2s}
.row-amount input:focus{background:var(--bg-secondary);box-shadow:0 0 0 2px var(--accent)}
.row-amount input.forecast-input:focus{box-shadow:0 0 0 2px var(--orange)}
.row-amount input.actual-input{color:var(--text-primary)}
.row-amount input.actual-input:focus{box-shadow:0 0 0 2px var(--green)}
.row-amount .auto-value{font-family:'Nunito',sans-serif;font-size:16px;font-weight:700;color:var(--annual-badge);text-align:right;padding:7px 10px}
.row-delete{display:flex;justify-content:center}
.row-delete button{width:28px;height:28px;border-radius:8px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:12px;transition:all .2s;display:flex;align-items:center;justify-content:center}
.row-delete button:hover{background:var(--red-bg);color:var(--red)}
.add-row-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:12px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;transition:all .2s}
.add-row-btn:hover{background:var(--accent-light)}
/* Annual rows */
.annual-row{display:grid;grid-template-columns:28px 1fr 110px 95px 95px 80px 90px 32px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);transition:background .15s;gap:4px}
.annual-row:last-child{border-bottom:none}
.annual-row:hover{background:var(--input-bg)}
.annual-col-headers{display:grid;grid-template-columns:28px 1fr 110px 95px 95px 80px 90px 32px;padding:4px 14px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);gap:4px;border-bottom:1px solid var(--border)}
.annual-col-headers span:nth-child(4),.annual-col-headers span:nth-child(5),.annual-col-headers span:nth-child(6){text-align:right}
.month-select{padding:7px 8px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);font-family:'Nunito',sans-serif;font-size:14px;font-weight:600;color:var(--text-primary);outline:none;cursor:pointer;width:100%}
.month-select:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.compte-select{padding:7px 6px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);font-family:'Nunito',sans-serif;font-size:12px;font-weight:600;color:var(--text-primary);outline:none;cursor:pointer;width:100%}
.compte-select:focus{border-color:var(--savings);box-shadow:0 0 0 2px var(--savings-light)}
.diff-value{font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;text-align:right;padding:7px 6px}
.diff-value.positive{color:var(--green)}
.diff-value.negative{color:var(--red)}
.diff-value.zero{color:var(--text-muted)}
.row-amount input.prevu-input:focus{box-shadow:0 0 0 2px var(--annual-badge)}
.row-amount input.preleve-input{color:var(--text-primary)}
.row-amount input.preleve-input:focus{box-shadow:0 0 0 2px var(--green)}
/* Summaries */
.annual-summary,.savings-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.annual-summary .summary-card .value{color:var(--annual-badge)}
.savings-summary .summary-card .value{color:var(--savings)}
/* Savings multi-line in month view */
.savings-line-row{display:grid;grid-template-columns:28px 1fr 130px 130px 32px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);transition:background .15s;gap:4px}
.savings-line-row:last-child{border-bottom:none}
.savings-line-row:hover{background:var(--input-bg)}
.savings-line-row .row-label input{color:var(--savings);font-weight:700}
.savings-line-row .row-amount input{color:var(--savings);font-weight:700}
.savings-line-row .row-amount input:focus{box-shadow:0 0 0 2px var(--savings)}
.savings-line-col-headers{display:grid;grid-template-columns:28px 1fr 130px 130px 32px;padding:4px 14px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);gap:4px;border-bottom:1px solid var(--border)}
.savings-line-col-headers span:nth-child(3){text-align:right}
.savings-line-col-headers span:nth-child(4){text-align:left;padding-left:6px}
.add-savings-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:12px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--savings);cursor:pointer;transition:all .2s}
.add-savings-btn:hover{background:var(--savings-bg)}
/* Savings account table - 6 cols with provisions + preleve + solde */
.account-table-header{display:grid;grid-template-columns:40px 1fr 90px 90px 90px 90px;padding:10px 18px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:2px solid var(--border)}
.account-table-header span:nth-child(3),.account-table-header span:nth-child(4),.account-table-header span:nth-child(5),.account-table-header span:nth-child(6){text-align:right}
.account-table-row{display:grid;grid-template-columns:40px 1fr 90px 90px 90px 90px;align-items:center;padding:12px 18px;border-bottom:1px solid var(--border);transition:background .15s}
.account-table-row:last-child{border-bottom:none}
.account-table-row:hover{background:var(--input-bg)}
.account-table-row .acct-icon{width:32px;height:32px;border-radius:8px;background:var(--savings-bg);color:var(--savings);display:flex;align-items:center;justify-content:center;font-size:13px}
.account-table-row .acct-name{font-size:14px;font-weight:700;color:var(--text-primary)}
.account-table-row .acct-count{font-size:11px;color:var(--text-muted);font-weight:600}
.account-table-row .acct-total{font-family:'DM Serif Display',serif;font-size:17px;color:var(--savings);text-align:right}
.account-table-row .acct-provision{font-size:13px;font-weight:700;color:var(--blue);text-align:right}
.account-table-row .acct-preleve{font-size:13px;font-weight:700;color:var(--annual-badge);text-align:right}
.account-table-row .acct-solde{font-size:15px;font-weight:800;text-align:right}
.account-table-row .acct-solde.positive{color:var(--green)}
.account-table-row .acct-solde.negative{color:var(--red)}
.account-table-row .acct-solde.zero{color:var(--text-muted)}
/* Create account input */
.create-account-area{display:flex;align-items:center;gap:8px;padding:12px 18px;border-top:1px solid var(--border)}
.create-account-area input{flex:1;border:1px solid var(--border);background:var(--input-bg);border-radius:8px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:16px;font-weight:600;color:var(--text-primary);outline:none;transition:all .2s}
.create-account-area input::placeholder{color:var(--text-muted)}
.create-account-area input:focus{border-color:var(--savings);box-shadow:0 0 0 2px var(--savings-light)}
.create-account-area button{padding:8px 16px;border:none;border-radius:8px;background:var(--savings);color:#FFF;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.create-account-area button:hover{opacity:.85}
/* Savings */
.savings-chart-container{padding:18px;position:relative}
.savings-chart-canvas{width:100%;height:200px;display:block}
.savings-goal-section{padding:16px 18px;border-top:1px solid var(--border)}
.savings-goal-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.savings-goal-row label{font-size:13px;font-weight:700;color:var(--text-secondary)}
.savings-goal-row input{border:1px solid var(--border);background:var(--input-bg);border-radius:8px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:16px;font-weight:700;color:var(--savings);width:140px;text-align:right;outline:none;transition:all .2s}
.savings-goal-row input:focus{border-color:var(--savings);box-shadow:0 0 0 2px var(--savings-light)}
.savings-goal-bar{width:100%;height:12px;border-radius:6px;background:var(--border);margin-top:12px;overflow:hidden}
.savings-goal-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--savings),var(--green));transition:width .5s ease}
.savings-goal-pct{margin-top:6px;font-size:13px;font-weight:700;color:var(--savings)}
.savings-table-header{display:grid;grid-template-columns:50px 1fr 100px 110px;padding:10px 18px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:2px solid var(--border)}
.savings-table-row{display:grid;grid-template-columns:50px 1fr 100px 110px;align-items:center;padding:12px 18px;border-bottom:1px solid var(--border);transition:background .15s}
.savings-table-row:last-child{border-bottom:none}
.savings-table-row:hover{background:var(--input-bg)}
.savings-table-row .month-label{font-size:13px;font-weight:800;color:var(--text-muted)}
.savings-table-row .month-name{font-size:14px;font-weight:700;color:var(--text-primary)}
.savings-table-row .sav-amount{font-size:16px;font-weight:700;color:var(--savings);text-align:right}
.savings-table-row .sav-cumul{font-family:'DM Serif Display',serif;font-size:17px;color:var(--text-primary);text-align:right}
.savings-table-row.has-value .sav-cumul{color:var(--savings)}
/* Distribution bars */
.annual-month-dist{padding:14px 18px}
.dist-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.dist-label{font-size:12px;font-weight:700;color:var(--text-muted);width:36px}
.dist-bar{flex:1;height:8px;border-radius:4px;background:var(--border);overflow:hidden}
.dist-bar-fill{height:100%;border-radius:4px;background:var(--annual-badge);transition:width .4s}
.dist-bar-fill.savings-fill{background:var(--savings)}
.dist-amount{font-size:12px;font-weight:700;color:var(--text-secondary);width:70px;text-align:right}
/* Recap table */
.recap-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.recap-summary .summary-card .value{color:var(--recap)}
.recap-summary .summary-card.income .value{color:var(--green)}
.recap-summary .summary-card.expense .value{color:var(--red)}
.recap-summary .summary-card.balance .value.positive{color:var(--green)}
.recap-summary .summary-card.balance .value.negative{color:var(--red)}
.recap-table{width:100%;border-collapse:collapse}
.recap-table thead th{padding:10px 14px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:2px solid var(--border);text-align:left;position:sticky;top:0;background:var(--bg-card)}
.recap-table thead th:not(:first-child):not(:nth-child(2)){text-align:right}
.recap-table tbody td{padding:10px 14px;font-size:13px;font-weight:600;color:var(--text-primary);border-bottom:1px solid var(--border)}
.recap-table tbody td:not(:first-child):not(:nth-child(2)){text-align:right;font-variant-numeric:tabular-nums;font-size:12px}
.recap-table tbody tr:hover{background:var(--input-bg)}
.recap-table tbody tr.recap-section-row td{background:var(--input-bg);font-weight:800;font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;padding:8px 14px}
.recap-table .val-positive{color:var(--green)}.recap-table .val-negative{color:var(--red)}.recap-table .val-zero{color:var(--text-muted)}
.recap-table .recap-avg{font-weight:800;color:var(--recap)}
.recap-table .recap-label-icon{display:inline-flex;align-items:center;gap:6px}
.recap-table .recap-label-icon i{font-size:10px}
.recap-table tfoot td{padding:12px 14px;font-weight:800;font-size:14px;border-top:2px solid var(--border);background:var(--input-bg)}
.recap-table tfoot td:not(:first-child):not(:nth-child(2)){text-align:right}
.recap-filter-bar{display:flex;gap:8px;padding:14px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center}
.recap-filter-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all .2s}
.recap-filter-btn:hover{border-color:var(--recap);color:var(--recap)}
.recap-filter-btn.active{background:var(--recap);color:#FFF;border-color:var(--recap)}
/* Misc */
.empty-state{text-align:center;padding:32px 20px;color:var(--text-muted)}
.empty-state i{font-size:28px;margin-bottom:10px;display:block;color:var(--border)}
.empty-state p{font-size:13px}
.file-input-hidden{display:none}
.year-selector{display:flex;align-items:center;gap:6px}
.year-selector span{font-family:'DM Serif Display',serif;font-size:17px;min-width:50px;text-align:center}
.year-btn{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s}
.year-btn:hover{border-color:var(--accent);color:var(--accent)}
/* Modal & toast */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal{background:var(--bg-card);border-radius:var(--radius);padding:24px;max-width:440px;width:90%;box-shadow:var(--shadow-lg);transform:translateY(20px);transition:transform .25s}
.modal-overlay.show .modal{transform:translateY(0)}
.modal h3{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:12px}
.modal p{color:var(--text-secondary);font-size:14px;margin-bottom:20px;line-height:1.5}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
.modal-btn{padding:10px 20px;border-radius:10px;border:none;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.modal-btn.cancel{background:var(--bg-primary);color:var(--text-secondary)}.modal-btn.cancel:hover{background:var(--border)}
.modal-btn.confirm{background:var(--red);color:#FFF}.modal-btn.confirm:hover{opacity:.85}
.modal-btn.primary{background:var(--accent);color:#FFF}.modal-btn.primary:hover{opacity:.85}
.modal-btn.secondary{background:var(--blue);color:#FFF}.modal-btn.secondary:hover{opacity:.85}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:var(--shadow-lg);z-index:300;transition:transform .3s ease;display:flex;align-items:center;gap:8px}
.toast.show{transform:translateX(-50%) translateY(0)}
/* Dual balance in tabs */
.tab-dual-balance{display:flex;flex-direction:column;gap:0;margin-top:2px}
.tab-dual-balance .tab-bal-line{font-size:9px;font-weight:700;letter-spacing:.3px;line-height:1.2}
.tab-dual-balance .tab-bal-line.positive{color:var(--green)}
.tab-dual-balance .tab-bal-line.negative{color:var(--red)}
.tab-btn.active .tab-dual-balance .tab-bal-line.positive,
.tab-btn.active .tab-dual-balance .tab-bal-line.negative{color:rgba(255,255,255,.85)}
/* Scope choice buttons in add-row area */
.add-row-area{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;flex-wrap:wrap}
.add-row-area .add-row-btn{width:auto;padding:10px 16px;flex:0 0 auto}
.add-row-area .add-row-btn.month-only{color:var(--blue);font-size:12px}
.add-row-area .add-row-btn.month-only:hover{background:var(--blue-bg)}
.add-row-area .add-row-btn.year-all{color:var(--accent);font-size:12px}
.add-row-area .add-row-btn.year-all:hover{background:var(--accent-light)}
/* Annual summary 5 cols */
.annual-summary-5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.annual-summary-5 .summary-card .value{color:var(--annual-badge)}
.annual-summary-5 .summary-card.balance .value.positive{color:var(--green)}
.annual-summary-5 .summary-card.balance .value.negative{color:var(--red)}
.annual-summary-5 .summary-card .value.diff-pos{color:var(--green)}
.annual-summary-5 .summary-card .value.diff-neg{color:var(--red)}
/* Responsive */
@media(max-width:900px){
  .annual-row{grid-template-columns:24px 1fr 90px 80px 80px 65px 75px 28px;padding:6px 8px;gap:3px}
  .annual-col-headers{grid-template-columns:24px 1fr 90px 80px 80px 65px 75px 28px;padding:4px 8px;gap:3px}
  .annual-summary-5{grid-template-columns:repeat(3,1fr)}
  .account-table-header{grid-template-columns:36px 1fr 75px 75px 75px 75px;padding:8px 12px;font-size:10px}
  .account-table-row{grid-template-columns:36px 1fr 75px 75px 75px 75px;padding:10px 12px}
  .savings-line-row{grid-template-columns:24px 1fr 100px 100px 28px;padding:6px 10px}
  .savings-line-col-headers{grid-template-columns:24px 1fr 100px 100px 28px;padding:4px 10px}
}
@media(max-width:600px){
  .summary-row{grid-template-columns:1fr 1fr}
  .recap-summary{grid-template-columns:1fr 1fr}
  .annual-summary,.savings-summary{grid-template-columns:1fr}
  .annual-summary-5{grid-template-columns:1fr 1fr}
  .budget-row{grid-template-columns:24px 1fr 100px 28px;padding:6px 10px}
  .var-row{grid-template-columns:24px 1fr 80px 80px 28px;padding:6px 10px}
  .var-col-headers{grid-template-columns:24px 1fr 80px 80px 28px;padding:4px 10px}
  .annual-row{grid-template-columns:1fr;padding:10px 12px;gap:6px}
  .annual-col-headers{display:none}
  .annual-row .move-btns{display:none}
  .annual-row .row-label{order:1}
  .annual-row .row-amount{order:3}
  .annual-row > div{min-width:0}
  .annual-row-mobile-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
  .annual-row-mobile-meta{display:flex;gap:6px;flex-wrap:wrap}
  .savings-line-row{grid-template-columns:24px 1fr 80px 80px 28px;padding:6px 10px}
  .savings-line-col-headers{grid-template-columns:24px 1fr 80px 80px 28px;padding:4px 10px;font-size:9px}
  .savings-table-header{grid-template-columns:40px 1fr 80px 90px;padding:8px 12px;font-size:10px}
  .savings-table-row{grid-template-columns:40px 1fr 80px 90px;padding:10px 12px}
  .account-table-header{grid-template-columns:36px 1fr 65px 65px 65px 65px;padding:8px 10px;font-size:9px}
  .account-table-row{grid-template-columns:36px 1fr 65px 65px 65px 65px;padding:10px 10px}
  .section-header{padding:12px 14px}
  .summary-card .value{font-size:17px}
  .tab-btn{padding:7px 10px;font-size:12px}
  .header-top{flex-wrap:wrap;gap:8px}
  .savings-inline{flex-wrap:wrap;gap:10px}
  .row-amount input{font-size:15px;padding:6px 8px}
  .add-row-area{flex-direction:column}
  .add-row-area .add-row-btn{width:100%}
  .modal-actions{flex-direction:column}
  .modal-actions .modal-btn{width:100%;text-align:center}
  .recap-table{font-size:11px}
  .recap-table thead th{padding:8px 8px;font-size:9px}
  .recap-table tbody td{padding:8px 8px;font-size:11px}
  .recap-table tbody td:not(:first-child):not(:nth-child(2)){font-size:10px}
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.section{animation:fadeIn .35s ease forwards}
.section:nth-child(2){animation-delay:.05s}.section:nth-child(3){animation-delay:.1s}
.section:nth-child(4){animation-delay:.15s}.section:nth-child(5){animation-delay:.2s}
</style>
</head>
<body>
<div class="app-header">
  <div class="header-top">
    <div class="logo"><div class="logo-icon"><i class="fas fa-wallet"></i></div><h1>Mon Budget</h1></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="year-selector">
        <button class="year-btn" onclick="changeYear(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="yearDisplay">2025</span>
        <button class="year-btn" onclick="changeYear(1)"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="header-actions">
        <button class="btn-icon" onclick="exportData()" title="Exporter"><i class="fas fa-download"></i></button>
        <button class="btn-icon" onclick="triggerImport()" title="Importer"><i class="fas fa-upload"></i></button>
        <button class="btn-icon" onclick="showResetConfirm()" title="Réinitialiser"><i class="fas fa-rotate-left"></i></button>
      </div>
    </div>
  </div>
  <div class="tabs-container" id="tabsContainer"></div>
</div>
<div class="main-content" id="mainContent"></div>
<div class="modal-overlay" id="modalOverlay"><div class="modal" id="modalContent"></div></div>
<div class="toast" id="toast"><span class="toast-icon"></span><span class="toast-text"></span></div>
<input type="file" class="file-input-hidden" id="fileInput" accept=".json" onchange="importData(event)">

<script>
var MONTHS=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
var MONTHS_SHORT=['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];
var DEF_INCOME=[{label:'Salaire',amount:0}];
var DEF_EXPENSES=[{label:'Loyer',amount:0},{label:'Courses',amount:0},{label:'Électricité / Gaz',amount:0},{label:'Internet / Téléphone',amount:0},{label:'Transport',amount:0},{label:'Assurances',amount:0},{label:'Loisirs',amount:0}];
var DEF_VARIABLE=[{label:'Sorties / Restaurant',forecast:0,actual:0},{label:'Shopping',forecast:0,actual:0},{label:'Divers',forecast:0,actual:0}];

var currentYear=new Date().getFullYear(), currentTab=0, data={};
var recapFilter='all';
var STORAGE_KEY='monbudget_data';
var _store=(function(){try{var s=window.localStorage;s.setItem('__t','1');s.removeItem('__t');return s}catch(e){return null}})();
function saveToStorage(){if(!_store)return;try{_store.setItem(STORAGE_KEY,JSON.stringify(data))}catch(e){}}
function loadFromStorage(){if(!_store)return false;try{var s=_store.getItem(STORAGE_KEY);if(s){var p=JSON.parse(s);if(typeof p==='object'&&p!==null){data=p;return true}}}catch(e){}return false}
function getYearKey(){return 'y'+currentYear}

function initYearData(){
  var key=getYearKey();
  if(!data[key]){
    data[key]={months:[],annualExpenses:[],savingsGoal:0,savingsAccounts:[]};
    for(var i=0;i<12;i++) data[key].months.push({
      income:JSON.parse(JSON.stringify(DEF_INCOME)),
      expenses:JSON.parse(JSON.stringify(DEF_EXPENSES)),
      variableExpenses:JSON.parse(JSON.stringify(DEF_VARIABLE)),
      savingsLines:[]
    });
  }
  var yd=data[key];
  if(typeof yd.savingsGoal==='undefined') yd.savingsGoal=0;
  if(!yd.savingsAccounts) yd.savingsAccounts=[];
  for(var j=0;j<12;j++){
    var md=yd.months[j];
    if(!md.savingsLines){
      md.savingsLines=[];
      if(typeof md.savings==='number' && md.savings>0){
        md.savingsLines.push({label:'Épargne',amount:md.savings});
      }
      delete md.savings;
    }
    if(!md.variableExpenses) md.variableExpenses=JSON.parse(JSON.stringify(DEF_VARIABLE));
  }
  for(var a=0;a<yd.annualExpenses.length;a++){
    var ae=yd.annualExpenses[a];
    if(typeof ae.prevu==='undefined'){
      ae.prevu=parseFloat(ae.amount)||0;
      ae.preleve=0;
      delete ae.amount;
    }
    if(typeof ae.compte==='undefined') ae.compte='';
  }
}

function gM(m){initYearData();return data[getYearKey()].months[m]}
function gAE(){initYearData();return data[getYearKey()].annualExpenses}
function gSG(){initYearData();return data[getYearKey()].savingsGoal||0}
function sSG(v){initYearData();data[getYearKey()].savingsGoal=parseFloat(v)||0}

function gAFM(mi){return gAE().filter(function(a){return a.month===mi})}
function gATFM_prevu(mi){return gAFM(mi).reduce(function(s,a){return s+(parseFloat(a.prevu)||0)},0)}
function gATFM_preleve(mi){return gAFM(mi).reduce(function(s,a){return s+(parseFloat(a.preleve)||0)},0)}

function gTI(m){return gM(m).income.reduce(function(s,r){return s+(parseFloat(r.amount)||0)},0)}
function gTE(m){return gM(m).expenses.reduce(function(s,r){return s+(parseFloat(r.amount)||0)},0)}

function gMS(m){
  var lines=gM(m).savingsLines;
  var t=0;for(var i=0;i<lines.length;i++) t+=(parseFloat(lines[i].amount)||0);
  return t;
}
function gVF(m){return gM(m).variableExpenses.reduce(function(s,r){return s+(parseFloat(r.forecast)||0)},0)}
function gVA(m){return gM(m).variableExpenses.reduce(function(s,r){return s+(parseFloat(r.actual)||0)},0)}

// Provision — monthly amounts saved toward annual expenses
function gAPFM(mi){
  var annuals=gAE(),total=0,details=[];
  for(var i=0;i<annuals.length;i++){
    var a=annuals[i],dm=a.month,amt=parseFloat(a.prevu)||0;
    if(amt<=0||dm===0)continue;
    if(mi<dm){var ms=dm,mc=amt/ms;total+=mc;details.push({label:a.label||'Dépense annuelle',monthlyAmount:mc,fullAmount:amt,dueMonth:dm,monthsToSave:ms,compte:a.compte||''})}
  }
  return{total:total,details:details};
}
function gPTFM(mi){return gAPFM(mi).total}

// Get provision amount feeding a specific savings account for a given month
// Months before due: +prevu/dueMonth (provision inflow)
// At due month: -preleve (actual withdrawal)
function getProvisionForAccount(accountName, mi){
  var annuals=gAE(),total=0;
  for(var i=0;i<annuals.length;i++){
    var a=annuals[i],dm=a.month,amt=parseFloat(a.prevu)||0;
    if(amt<=0||dm===0)continue;
    if((a.compte||'')!==accountName) continue;
    // Before due month: provision inflow
    if(mi<dm){total+=amt/dm}
    // At due month: deduct the actual preleve amount
    if(mi===dm){total-=(parseFloat(a.preleve)||0)}
  }
  return total;
}

// Get cumulative provision balance for an account up to month mi
function getProvisionCumulForAccount(accountName, upToMonth){
  var total=0;
  for(var m=0;m<=upToMonth;m++){
    total+=getProvisionForAccount(accountName, m);
  }
  return total;
}

// Get total provisions accumulated for an account across all 12 months
function getTotalProvisionsForAccount(accountName){
  return getProvisionCumulForAccount(accountName, 11);
}

// Get total preleve (actual withdrawals) from an account across all annual expenses
function getTotalPreleveForAccount(accountName){
  var annuals=gAE(),total=0;
  for(var i=0;i<annuals.length;i++){
    if((annuals[i].compte||'')===accountName){
      total+=(parseFloat(annuals[i].preleve)||0);
    }
  }
  return total;
}

// Get total provision inflows only (without deductions) for an account
function getTotalProvisionInflowForAccount(accountName){
  var annuals=gAE(),total=0;
  for(var i=0;i<annuals.length;i++){
    var a=annuals[i],dm=a.month,amt=parseFloat(a.prevu)||0;
    if(amt<=0||dm===0)continue;
    if((a.compte||'')!==accountName) continue;
    // Sum all monthly inflows across months 0 to dm-1
    // = amt/dm * dm = amt (full amount provisioned over the year)
    // But only count months that exist (0-11), so if dm > 0:
    var monthsProvided=Math.min(dm, 12);
    total+=(amt/dm)*monthsProvided;
  }
  return total;
}

// ===== SOLDE MOIS PRECEDENT =====
function getCarryoverFromPrevMonth(m){
  if(m===0) {
    var prevKey='y'+(currentYear-1);
    if(data[prevKey] && data[prevKey].months){
      return computeBalActualFull(11, currentYear-1);
    }
    return 0;
  }
  return computeBalActualFull(m-1, currentYear);
}

function computeBalActualFull(m, year){
  var savedYear=currentYear;
  currentYear=year;
  initYearData();
  var ti=gTI(m), te=gTE(m), at_preleve=gATFM_preleve(m), sv=gMS(m), pt=gPTFM(m), va=gVA(m);
  var ownBal=ti-te-at_preleve-sv-pt-va;
  var carry=0;
  if(m===0){
    var prevKey='y'+(year-1);
    if(data[prevKey] && data[prevKey].months){
      carry=computeBalActualFull(11, year-1);
    }
  } else {
    carry=computeBalActualFull(m-1, year);
  }
  currentYear=savedYear;
  initYearData();
  return ownBal+carry;
}

// Balances
function balForecast(m){return gTI(m)-gTE(m)-gATFM_prevu(m)-gMS(m)-gPTFM(m)-gVF(m)}
function balActual(m){return gTI(m)-gTE(m)-gATFM_preleve(m)-gMS(m)-gPTFM(m)-gVA(m)}
function balActualFull(m){
  return computeBalActualFull(m, currentYear);
}

function gTSY(){var t=0;for(var i=0;i<12;i++)t+=gMS(i);return t}
function gCS(u){var t=0;for(var i=0;i<=u;i++)t+=gMS(i);return t}
function fmt(n){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(n)}

// Get all savings account names across the year
function getAllSavingsAccountNames(){
  initYearData();
  var yd=data[getYearKey()],names={};
  if(yd.savingsAccounts){
    for(var c=0;c<yd.savingsAccounts.length;c++){
      var n=yd.savingsAccounts[c].trim();
      if(n) names[n]=true;
    }
  }
  for(var m=0;m<12;m++){
    var lines=yd.months[m].savingsLines;
    for(var i=0;i<lines.length;i++){
      var lbl=(lines[i].label||'').trim();
      if(lbl) names[lbl]=true;
    }
  }
  return Object.keys(names).sort();
}

// Get per-account totals (manual deposits from savings lines)
function getSavingsAccountTotals(){
  initYearData();
  var yd=data[getYearKey()],accounts={};
  for(var m=0;m<12;m++){
    var lines=yd.months[m].savingsLines;
    for(var i=0;i<lines.length;i++){
      var lbl=(lines[i].label||'').trim();
      if(!lbl) continue;
      if(!accounts[lbl]) accounts[lbl]={total:0,months:0};
      var amt=parseFloat(lines[i].amount)||0;
      if(amt!==0){accounts[lbl].total+=amt;accounts[lbl].months++}
    }
  }
  var allNames=getAllSavingsAccountNames();
  for(var a=0;a<allNames.length;a++){
    if(!accounts[allNames[a]]) accounts[allNames[a]]={total:0,months:0};
  }
  return accounts;
}

function getAnnualUseForAccount(accountName){
  var annuals=gAE(),total=0;
  for(var i=0;i<annuals.length;i++){
    if((annuals[i].compte||'')=== accountName) total+=(parseFloat(annuals[i].prevu)||0);
  }
  return total;
}

// Dark mode
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches)document.documentElement.classList.add('dark');
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(e){if(e.matches)document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark')});

// ===== TABS =====
function renderTabs(){
  var c=document.getElementById('tabsContainer'),h='';
  for(var i=0;i<12;i++){
    var ba=balActualFull(i);
    var clsA=ba>=0?'positive':'negative';
    var act=currentTab===i?' active':'';
    h+='<button class="tab-btn'+act+'" onclick="switchTab('+i+')">'+MONTHS_SHORT[i];
    h+='<div class="tab-dual-balance">';
    h+='<span class="tab-bal-line '+clsA+'">'+fmt(ba)+'</span>';
    h+='</div></button>';
  }
  h+='<button class="tab-btn annual-tab'+(currentTab===12?' active':'')+'" onclick="switchTab(12)"><i class="fas fa-calendar-alt"></i> Annuelles</button>';
  h+='<button class="tab-btn savings-tab'+(currentTab===13?' active':'')+'" onclick="switchTab(13)"><i class="fas fa-piggy-bank"></i> Épargne';
  var ts=gTSY();if(ts>0)h+='<span class="tab-balance positive">'+fmt(ts)+'</span>';
  h+='</button>';
  h+='<button class="tab-btn recap-tab'+(currentTab===14?' active':'')+'" onclick="switchTab(14)"><i class="fas fa-table-list"></i> Récap</button>';
  c.innerHTML=h;
}
function switchTab(i){currentTab=i;renderTabs();renderContent();var b=document.querySelectorAll('.tab-btn');if(b[i])b[i].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'})}

// ===== RENDER =====
function renderContent(){
  if(currentTab<12)renderMonthPage(currentTab);
  else if(currentTab===12)renderAnnualPage();
  else if(currentTab===13)renderSavingsPage();
  else renderRecapPage();
}

function moveBtns(type,m,idx,len){
  var h='<div class="move-btns">';
  h+='<button class="move-btn" '+(idx===0?'disabled style="opacity:.2"':'onclick="moveRow(\''+type+'\','+m+','+idx+',-1)"')+'><i class="fas fa-chevron-up"></i></button>';
  h+='<button class="move-btn" '+(idx>=len-1?'disabled style="opacity:.2"':'onclick="moveRow(\''+type+'\','+m+','+idx+',1)"')+'><i class="fas fa-chevron-down"></i></button>';
  h+='</div>';return h;
}

function renderMonthPage(m){
  var md=gM(m),ti=gTI(m),te=gTE(m),at_prevu=gATFM_prevu(m),at_preleve=gATFM_preleve(m),sv=gMS(m),prov=gAPFM(m),pt=prov.total;
  var vf=gVF(m),va=gVA(m);
  var carry=getCarryoverFromPrevMonth(m);
  var bf=ti-te-at_prevu-sv-pt-vf, ba=ti-te-at_preleve-sv-pt-va;
  var bfFull=bf+carry, baFull=ba+carry;
  var totalExpensesHeader=te+va;
  var h='';
  // Summary
  h+='<div class="summary-row">';
  h+='<div class="summary-card income"><div class="label">Revenus</div><div class="value">'+fmt(ti)+'</div></div>';
  h+='<div class="summary-card expense"><div class="label">Dépenses</div><div class="value">'+fmt(totalExpensesHeader)+'</div></div>';
  h+='<div class="summary-card balance"><div class="label">Solde prévisionnel</div><div class="value '+(bfFull>=0?'positive':'negative')+'">'+fmt(bfFull)+'</div>';
  var ratioF=ti>0?Math.min(100,Math.max(0,(bfFull/ti)*100)):0;
  h+='<div class="balance-bar"><div class="balance-bar-fill '+(bfFull>=0?'positive':'negative')+'" style="width:'+Math.abs(ratioF)+'%"></div></div></div>';
  h+='<div class="summary-card balance"><div class="label">Solde réel</div><div class="value '+(baFull>=0?'positive':'negative')+'">'+fmt(baFull)+'</div>';
  var ratioA=ti>0?Math.min(100,Math.max(0,(baFull/ti)*100)):0;
  h+='<div class="balance-bar"><div class="balance-bar-fill '+(baFull>=0?'positive':'negative')+'" style="width:'+Math.abs(ratioA)+'%"></div></div></div>';
  h+='</div>';

  // Carryover from previous month
  if(carry!==0){
    h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon carryover-icon"><i class="fas fa-right-left"></i></span>Solde mois précédent<span class="carryover-badge">AUTO</span></div><div class="section-total" style="color:'+(carry>=0?'var(--green)':'var(--red)')+'">'+fmt(carry)+'</div></div>';
    h+='<div class="budget-row carryover-row"><div class="row-label" style="color:var(--carryover);font-weight:700">Report '+(m===0?'année '+(currentYear-1)+' — Décembre':MONTHS[m-1])+'</div>';
    h+='<div class="row-amount"><div class="auto-value" style="color:'+(carry>=0?'var(--green)':'var(--red)')+'">'+fmt(carry)+'</div></div></div>';
    h+='</div>';
  }

  // Income
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon income-icon"><i class="fas fa-arrow-down"></i></span>Revenus</div><div class="section-total income-total">'+fmt(ti)+'</div></div>';
  for(var i=0;i<md.income.length;i++) h+=buildRow('income',m,i,md.income[i],md.income.length);
  h+=buildAddArea('income',m);
  h+='</div>';

  // Fixed expenses
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon expense-icon"><i class="fas fa-arrow-up"></i></span>Dépenses fixes</div><div class="section-total expense-total">'+fmt(te)+'</div></div>';
  for(var j=0;j<md.expenses.length;j++) h+=buildRow('expenses',m,j,md.expenses[j],md.expenses.length);
  h+=buildAddArea('expenses',m);
  h+='</div>';

  // Variable expenses
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon variable-icon"><i class="fas fa-shuffle"></i></span>Dépenses variables</div>';
  h+='<div style="text-align:right"><div style="font-size:11px;font-weight:700;color:var(--text-muted)">Prévu: <span style="color:var(--orange)">'+fmt(vf)+'</span></div>';
  h+='<div style="font-size:11px;font-weight:700;color:var(--text-muted)">Réel: <span style="color:var(--text-primary)">'+fmt(va)+'</span></div></div></div>';
  h+='<div class="var-col-headers"><span></span><span>Intitulé</span><span style="text-align:right">Prévu</span><span style="text-align:right">Réel</span><span></span></div>';
  for(var v=0;v<md.variableExpenses.length;v++) h+=buildVarRow(m,v,md.variableExpenses[v],md.variableExpenses.length);
  h+=buildAddArea('variableExpenses',m);
  h+='</div>';

  // Provision
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon provision-icon"><i class="fas fa-vault"></i></span>Épargne dép. annuelles<span class="provision-badge">AUTO</span></div><div class="section-total provision-total">'+fmt(pt)+'</div></div>';
  if(prov.details.length===0){h+='<div class="empty-state"><i class="fas fa-check-circle"></i><p>Aucun provisionnement ce mois.</p></div>';}
  else{for(var p=0;p<prov.details.length;p++){var pr=prov.details[p],rm=pr.dueMonth-m;
    h+='<div class="budget-row provision-row"><div class="row-label"><div class="provision-detail-label"><span class="prov-name">'+escapeHtml(pr.label)+(pr.compte?' <small style="color:var(--savings);font-weight:800">\u2192 '+escapeHtml(pr.compte)+'</small>':'')+'</span><span class="prov-meta">'+fmt(pr.fullAmount)+' en '+MONTHS[pr.dueMonth]+' — encore '+rm+' mois</span></div></div><div class="row-amount"><div class="auto-value">'+fmt(pr.monthlyAmount)+'</div></div><div class="row-delete"></div></div>';}}
  h+='</div>';

  // Annual due this month
  var annuals=gAFM(m);
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-calendar-check"></i></span>Sorties annuelles<span class="auto-badge">AUTO</span></div><div class="section-total annual-total">'+fmt(at_prevu)+'</div></div>';
  if(annuals.length===0){h+='<div class="empty-state"><i class="fas fa-calendar-xmark"></i><p>Aucune sortie annuelle ce mois.</p></div>';}
  else{for(var k=0;k<annuals.length;k++){
    var ae=annuals[k],diff=((parseFloat(ae.prevu)||0)-(parseFloat(ae.preleve)||0));
    var diffCls=diff>0?'positive':(diff<0?'negative':'zero');
    h+='<div class="budget-row auto-row" style="grid-template-columns:1fr 90px 90px 70px">';
    h+='<div class="row-label">'+escapeHtml(ae.label)+(ae.compte?' <small style="color:var(--savings);font-weight:800">'+escapeHtml(ae.compte)+'</small>':'')+'</div>';
    h+='<div class="row-amount"><div class="auto-value" style="font-size:13px">'+fmt(ae.prevu)+'</div></div>';
    h+='<div class="row-amount"><div class="auto-value" style="font-size:13px;color:var(--text-primary)">'+fmt(ae.preleve)+'</div></div>';
    h+='<div class="diff-value '+diffCls+'">'+fmt(diff)+'</div>';
    h+='</div>';
  }}
  h+='</div>';

  // Savings multi-line with account dropdown
  var accounts=getAllSavingsAccountNames();
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-piggy-bank"></i></span>Épargne du mois</div><div class="section-total savings-total">'+fmt(sv)+'</div></div>';
  if(md.savingsLines.length===0){
    h+='<div class="empty-state"><i class="fas fa-coins"></i><p>Aucune ligne d\'épargne ce mois.</p></div>';
  } else {
    h+='<div class="savings-line-col-headers"><span></span><span>Compte</span><span style="text-align:right">Montant</span><span></span><span></span></div>';
    for(var sl=0;sl<md.savingsLines.length;sl++){
      var line=md.savingsLines[sl];
      h+='<div class="savings-line-row">';
      h+=moveBtns('savingsLines',m,sl,md.savingsLines.length);
      h+='<div><select class="compte-select" style="width:100%" onchange="updateSavingsLineLabel('+m+','+sl+',this.value)">';
      h+='<option value=""'+(!line.label?' selected':'')+'>— Choisir —</option>';
      for(var ac=0;ac<accounts.length;ac++){
        h+='<option value="'+escapeAttr(accounts[ac])+'"'+(accounts[ac]===line.label?' selected':'')+'>'+escapeHtml(accounts[ac])+'</option>';
      }
      if(line.label && accounts.indexOf(line.label)===-1){
        h+='<option value="'+escapeAttr(line.label)+'" selected>'+escapeHtml(line.label)+'</option>';
      }
      h+='</select></div>';
      h+='<div class="row-amount"><input type="number" inputmode="decimal" value="'+(line.amount||'')+'" placeholder="0" onfocus="this.select()" onchange="updateSavingsLineAmount('+m+','+sl+',this.value)"></div>';
      h+='<div></div>';
      h+='<div class="row-delete"><button onclick="deleteSavingsLine('+m+','+sl+')"><i class="fas fa-xmark"></i></button></div></div>';
    }
  }
  h+='<button class="add-savings-btn" onclick="addSavingsLine('+m+')"><i class="fas fa-plus"></i> Ajouter une ligne d\'épargne</button>';
  h+='</div>';

  document.getElementById('mainContent').innerHTML=h;
}

function buildRow(type,m,idx,row,len){
  var h='<div class="budget-row">'+moveBtns(type,m,idx,len);
  h+='<div class="row-label"><input type="text" value="'+escapeAttr(row.label)+'" placeholder="Intitulé…" onchange="handleLabelChange(\''+type+'\','+m+','+idx+',this.value)"></div>';
  h+='<div class="row-amount"><input type="number" inputmode="decimal" value="'+(row.amount||'')+'" placeholder="0" onfocus="this.select()" onchange="updateAmount(\''+type+'\','+m+','+idx+',this.value)"></div>';
  h+='<div class="row-delete"><button onclick="handleDeleteRow(\''+type+'\','+m+','+idx+')"><i class="fas fa-xmark"></i></button></div></div>';
  return h;
}

function buildVarRow(m,idx,row,len){
  var h='<div class="var-row">'+moveBtns('variableExpenses',m,idx,len);
  h+='<div class="row-label"><input type="text" value="'+escapeAttr(row.label)+'" placeholder="Intitulé…" onchange="handleLabelChange(\'variableExpenses\','+m+','+idx+',this.value)"></div>';
  h+='<div class="row-amount"><input type="number" inputmode="decimal" class="forecast-input" value="'+(row.forecast||'')+'" placeholder="0" onfocus="this.select()" onchange="updateVarAmount('+m+','+idx+',\'forecast\',this.value)"></div>';
  h+='<div class="row-amount"><input type="number" inputmode="decimal" class="actual-input" value="'+(row.actual||'')+'" placeholder="0" onfocus="this.select()" onchange="updateVarAmount('+m+','+idx+',\'actual\',this.value)"></div>';
  h+='<div class="row-delete"><button onclick="handleDeleteRow(\'variableExpenses\','+m+','+idx+')"><i class="fas fa-xmark"></i></button></div></div>';
  return h;
}

function buildAddArea(type,m){
  var labelType='';
  if(type==='income') labelType='un revenu';
  else if(type==='expenses') labelType='une dépense fixe';
  else labelType='une dépense variable';
  var h='<div class="add-row-area">';
  h+='<button class="add-row-btn year-all" onclick="addRowYear(\''+type+'\','+m+')"><i class="fas fa-plus"></i> Ajouter '+labelType+' <small>(toute l\'année)</small></button>';
  h+='<button class="add-row-btn month-only" onclick="addRowMonth(\''+type+'\','+m+')"><i class="fas fa-plus-circle"></i> Ajouter '+labelType+' <small>('+MONTHS_SHORT[m]+' seul)</small></button>';
  h+='</div>';
  return h;
}

// ===== ANNUAL PAGE =====
function renderAnnualPage(){
  var annuals=gAE();
  var tPrevu=annuals.reduce(function(s,a){return s+(parseFloat(a.prevu)||0)},0);
  var tPreleve=annuals.reduce(function(s,a){return s+(parseFloat(a.preleve)||0)},0);
  var tDiff=tPrevu-tPreleve;
  var avgP=tPrevu/12;
  var perMonth=[],mx=0;
  for(var mi=0;mi<12;mi++){var t=gATFM_prevu(mi);perMonth.push(t);if(t>mx)mx=t}
  var tiy=0,tey=0;for(var yi=0;yi<12;yi++){tiy+=gTI(yi);tey+=gTE(yi)}
  var yb=tiy-tey-tPrevu-gTSY();
  var diffCls=tDiff>0?'diff-pos':(tDiff<0?'diff-neg':'');

  var h='<div class="annual-summary-5">';
  h+='<div class="summary-card"><div class="label">Total prévu</div><div class="value" style="color:var(--annual-badge)">'+fmt(tPrevu)+'</div></div>';
  h+='<div class="summary-card"><div class="label">Total prélevé</div><div class="value" style="color:var(--text-primary)">'+fmt(tPreleve)+'</div></div>';
  h+='<div class="summary-card"><div class="label">Différence</div><div class="value '+diffCls+'">'+fmt(tDiff)+'</div></div>';
  h+='<div class="summary-card"><div class="label">Moyenne / mois</div><div class="value" style="color:var(--annual-badge)">'+fmt(avgP)+'</div></div>';
  h+='<div class="summary-card balance"><div class="label">Bilan année</div><div class="value '+(yb>=0?'positive':'negative')+'">'+fmt(yb)+'</div></div></div>';

  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-chart-bar"></i></span>Répartition mensuelle</div></div><div class="annual-month-dist">';
  for(var di=0;di<12;di++){var pct=mx>0?(perMonth[di]/mx)*100:0;h+='<div class="dist-row"><span class="dist-label">'+MONTHS_SHORT[di]+'</span><div class="dist-bar"><div class="dist-bar-fill" style="width:'+pct+'%"></div></div><span class="dist-amount">'+fmt(perMonth[di])+'</span></div>';}
  h+='</div></div>';

  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-calendar-alt"></i></span>Dépenses annuelles</div><div class="section-total annual-total">'+fmt(tPrevu)+'</div></div>';
  if(annuals.length===0){h+='<div class="empty-state"><i class="fas fa-calendar-plus"></i><p>Aucune dépense annuelle.</p></div>';}
  else{
    h+='<div class="annual-col-headers"><span></span><span>Intitulé</span><span>Compte</span><span style="text-align:right">Prévu</span><span style="text-align:right">Prélevé</span><span style="text-align:right">Diff.</span><span>Mois</span><span></span></div>';
    for(var ai=0;ai<annuals.length;ai++)h+=buildAnnualRow(ai,annuals[ai],annuals.length);
  }
  h+='<button class="add-row-btn" onclick="addAnnualExpense()"><i class="fas fa-plus"></i> Ajouter une dépense annuelle</button></div>';
  document.getElementById('mainContent').innerHTML=h;
}

function buildAnnualRow(idx,row,len){
  var accounts=getAllSavingsAccountNames();
  var prevu=parseFloat(row.prevu)||0;
  var preleve=parseFloat(row.preleve)||0;
  var diff=prevu-preleve;
  var diffCls=diff>0?'positive':(diff<0?'negative':'zero');

  var h='<div class="annual-row">'+moveBtns('annual',-1,idx,len);
  h+='<div class="row-label"><input type="text" value="'+escapeAttr(row.label)+'" placeholder="Intitulé…" onchange="updateAnnualLabel('+idx+',this.value)"></div>';
  h+='<div><select class="compte-select" onchange="updateAnnualCompte('+idx+',this.value)">';
  h+='<option value=""'+((!row.compte)?' selected':'')+'>— Aucun —</option>';
  for(var c=0;c<accounts.length;c++){
    h+='<option value="'+escapeAttr(accounts[c])+'"'+(accounts[c]===row.compte?' selected':'')+'>'+escapeHtml(accounts[c])+'</option>';
  }
  h+='</select></div>';
  h+='<div class="row-amount"><input type="number" inputmode="decimal" class="prevu-input" value="'+(prevu||'')+'" placeholder="0" onfocus="this.select()" onchange="updateAnnualPrevu('+idx+',this.value)"></div>';
  h+='<div class="row-amount"><input type="number" inputmode="decimal" class="preleve-input" value="'+(preleve||'')+'" placeholder="0" onfocus="this.select()" onchange="updateAnnualPreleve('+idx+',this.value)"></div>';
  h+='<div class="diff-value '+diffCls+'">'+fmt(diff)+'</div>';
  h+='<div><select class="month-select" onchange="updateAnnualMonth('+idx+',this.value)">';
  for(var sm=0;sm<12;sm++){h+='<option value="'+sm+'"'+(sm===row.month?' selected':'')+'>'+MONTHS_SHORT[sm]+'</option>'}
  h+='</select></div><div class="row-delete"><button onclick="deleteAnnualExpense('+idx+')"><i class="fas fa-xmark"></i></button></div></div>';
  return h;
}

// ===== SAVINGS PAGE =====
function renderSavingsPage(){
  var ts=gTSY(),goal=gSG(),avg=ts/12,gPct=goal>0?Math.min(100,(ts/goal)*100):0;
  var mSav=[],mxS=0;for(var si=0;si<12;si++){var sv=gMS(si);mSav.push(sv);if(sv>mxS)mxS=sv}
  var h='<div class="savings-summary">';
  h+='<div class="summary-card savings-card"><div class="label">Total épargné</div><div class="value">'+fmt(ts)+'</div></div>';
  h+='<div class="summary-card savings-card"><div class="label">Moyenne / mois</div><div class="value">'+fmt(avg)+'</div></div>';
  h+='<div class="summary-card'+(goal>0?' savings-card':'')+'"><div class="label">Objectif</div><div class="value"'+(goal<=0?' style="color:var(--text-muted)"':'')+'>'+  (goal>0?fmt(goal):'Non défini')+'</div></div></div>';

  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-bullseye"></i></span>Objectif annuel</div></div><div class="savings-goal-section"><div class="savings-goal-row"><label>Montant cible :</label><input type="number" inputmode="decimal" value="'+(goal||'')+'" placeholder="Ex: 5000" onfocus="this.select()" onchange="updateGoal(this.value)"></div>';
  if(goal>0){h+='<div class="savings-goal-bar"><div class="savings-goal-fill" style="width:'+gPct+'%"></div></div><div class="savings-goal-pct">'+fmt(ts)+' / '+fmt(goal)+' — '+gPct.toFixed(1)+'%</div>'}
  h+='</div></div>';

  // Per-account totals with provisions integrated
  var accountTotals=getSavingsAccountTotals();
  var accountNames=Object.keys(accountTotals).sort();
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-landmark"></i></span>Comptes d\'épargne</div><div class="section-total savings-total">'+fmt(ts)+'</div></div>';
  if(accountNames.length===0){
    h+='<div class="empty-state"><i class="fas fa-piggy-bank"></i><p>Créez un compte ci-dessous ou ajoutez des lignes d\'épargne dans les mois.</p></div>';
  } else {
    h+='<div class="account-table-header"><span></span><span>Compte</span><span style="text-align:right">Épargné</span><span style="text-align:right">Provisions</span><span style="text-align:right">Prélevé</span><span style="text-align:right">Solde</span></div>';
    for(var an=0;an<accountNames.length;an++){
      var name=accountNames[an],acct=accountTotals[name];
      // Provision inflows: cumulative provisions credited to this account over 12 months
      var provInflow=getTotalProvisionInflowForAccount(name);
      // Actual withdrawals from this account (preleve amounts)
      var totalPreleve=getTotalPreleveForAccount(name);
      // Effective balance = manual deposits + provision inflows - actual withdrawals
      var solde=acct.total+provInflow-totalPreleve;
      var soldeCls=solde>0.005?'positive':(solde<-0.005?'negative':'zero');
      h+='<div class="account-table-row">';
      h+='<div class="acct-icon"><i class="fas fa-landmark"></i></div>';
      h+='<div><div class="acct-name">'+escapeHtml(name)+'</div><div class="acct-count">'+acct.months+' mois alimenté'+(acct.months>1?'s':'')+'</div></div>';
      h+='<div class="acct-total">'+fmt(acct.total)+'</div>';
      h+='<div class="acct-provision">'+(provInflow>0?'+'+fmt(provInflow):'—')+'</div>';
      h+='<div class="acct-preleve">'+(totalPreleve>0?'-'+fmt(totalPreleve):'—')+'</div>';
      h+='<div class="acct-solde '+soldeCls+'">'+fmt(solde)+'</div>';
      h+='</div>';
    }
  }
  // Create account input
  h+='<div class="create-account-area"><input type="text" id="newAccountInput" placeholder="Nom du nouveau compte…"><button onclick="createSavingsAccount()"><i class="fas fa-plus"></i> Créer</button></div>';
  h+='</div>';

  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-chart-area"></i></span>Évolution cumulative</div></div><div class="savings-chart-container"><canvas class="savings-chart-canvas" id="savingsChart"></canvas></div></div>';
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-chart-bar"></i></span>Épargne par mois</div></div><div class="annual-month-dist">';
  for(var di=0;di<12;di++){var pct=mxS>0?(mSav[di]/mxS)*100:0;h+='<div class="dist-row"><span class="dist-label">'+MONTHS_SHORT[di]+'</span><div class="dist-bar"><div class="dist-bar-fill savings-fill" style="width:'+pct+'%"></div></div><span class="dist-amount">'+fmt(mSav[di])+'</span></div>'}
  h+='</div></div>';
  h+='<div class="section"><div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-list"></i></span>Détail mensuel</div><div class="section-total savings-total">'+fmt(ts)+'</div></div>';
  h+='<div class="savings-table-header"><span></span><span>Mois</span><span style="text-align:right">Épargne</span><span style="text-align:right">Cumul</span></div>';
  for(var ti2=0;ti2<12;ti2++){var sV=gMS(ti2),cu=gCS(ti2),hv=sV>0?' has-value':'';h+='<div class="savings-table-row'+hv+'"><span class="month-label">'+(ti2+1)+'</span><span class="month-name">'+MONTHS[ti2]+'</span><span class="sav-amount">'+(sV>0?fmt(sV):'—')+'</span><span class="sav-cumul">'+(cu>0?fmt(cu):'—')+'</span></div>'}
  h+='</div>';
  document.getElementById('mainContent').innerHTML=h;
  drawSavingsChart(mSav,goal);
}

function createSavingsAccount(){
  var input=document.getElementById('newAccountInput');
  if(!input) return;
  var name=input.value.trim();
  if(!name){
    showToast('fa-exclamation-triangle','Veuillez entrer un nom de compte');
    return;
  }
  initYearData();
  var yd=data[getYearKey()];
  if(!yd.savingsAccounts) yd.savingsAccounts=[];
  var existing=getAllSavingsAccountNames();
  if(existing.indexOf(name)!==-1){
    showToast('fa-exclamation-triangle','Ce compte existe déjà');
    return;
  }
  yd.savingsAccounts.push(name);
  saveToStorage();
  renderContent();
  showToast('fa-check-circle','Compte « '+name+' » créé');
}

function drawSavingsChart(mSav,goal){
  var canvas=document.getElementById('savingsChart');if(!canvas)return;
  var ctx=canvas.getContext('2d'),dpr=window.devicePixelRatio||1,rect=canvas.getBoundingClientRect();
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.scale(dpr,dpr);
  var W=rect.width,H=rect.height,cumData=[],run=0;
  for(var i=0;i<12;i++){run+=mSav[i];cumData.push(run)}
  var maxV=Math.max.apply(null,cumData);if(goal>0&&goal>maxV)maxV=goal;if(maxV===0)maxV=1;
  var pL=10,pR=10,pT=20,pB=30,cW=W-pL-pR,cH=H-pT-pB;
  var dk=document.documentElement.classList.contains('dark');
  var gc=dk?'rgba(255,255,255,.06)':'rgba(0,0,0,.06)',tc=dk?'#6E6A62':'#9E9E9E',sc=dk?'#4EC4C4':'#2E8B8B',fc=dk?'rgba(78,196,196,.15)':'rgba(46,139,139,.1)',glc=dk?'rgba(110,189,132,.4)':'rgba(90,154,110,.3)';
  ctx.strokeStyle=gc;ctx.lineWidth=1;
  for(var g=0;g<=4;g++){var gy=pT+(cH/4)*g;ctx.beginPath();ctx.moveTo(pL,gy);ctx.lineTo(W-pR,gy);ctx.stroke()}
  if(goal>0){var gY=pT+cH-(goal/maxV)*cH;ctx.strokeStyle=glc;ctx.lineWidth=2;ctx.setLineDash([6,4]);ctx.beginPath();ctx.moveTo(pL,gY);ctx.lineTo(W-pR,gY);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle=glc;ctx.font='600 11px Nunito';ctx.fillText('Objectif',W-pR-52,gY-5)}
  ctx.beginPath();for(var a=0;a<12;a++){var ax=pL+(a/11)*cW,ay=pT+cH-(cumData[a]/maxV)*cH;if(a===0)ctx.moveTo(ax,ay);else ctx.lineTo(ax,ay)}
  ctx.lineTo(pL+cW,pT+cH);ctx.lineTo(pL,pT+cH);ctx.closePath();ctx.fillStyle=fc;ctx.fill();
  ctx.beginPath();ctx.strokeStyle=sc;ctx.lineWidth=3;ctx.lineJoin='round';ctx.lineCap='round';
  for(var l=0;l<12;l++){var lx=pL+(l/11)*cW,ly=pT+cH-(cumData[l]/maxV)*cH;if(l===0)ctx.moveTo(lx,ly);else ctx.lineTo(lx,ly)}ctx.stroke();
  for(var d=0;d<12;d++){var dx=pL+(d/11)*cW,dy=pT+cH-(cumData[d]/maxV)*cH;ctx.beginPath();ctx.arc(dx,dy,cumData[d]>0?4:2,0,Math.PI*2);ctx.fillStyle=cumData[d]>0?sc:gc;ctx.fill();if(cumData[d]>0){ctx.strokeStyle=dk?'#2A2A32':'#FFF';ctx.lineWidth=2;ctx.stroke()}}
  ctx.fillStyle=tc;ctx.font='700 10px Nunito';ctx.textAlign='center';
  for(var m=0;m<12;m++){ctx.fillText(MONTHS_SHORT[m],pL+(m/11)*cW,H-8)}
}

// ===== RECAP PAGE =====
function renderRecapPage(){
  initYearData();
  var yd=data[getYearKey()];
  var items=[];

  var incomeLabels={};
  for(var m=0;m<12;m++){
    var inc=yd.months[m].income;
    for(var i=0;i<inc.length;i++){
      var lbl=(inc[i].label||'').trim()||'(sans nom)';
      var key='income_'+lbl;
      if(!incomeLabels[key]) incomeLabels[key]={label:lbl,months:new Array(12).fill(0)};
      incomeLabels[key].months[m]+=(parseFloat(inc[i].amount)||0);
    }
  }

  var expLabels={};
  for(var m2=0;m2<12;m2++){
    var exp=yd.months[m2].expenses;
    for(var j=0;j<exp.length;j++){
      var lbl2=(exp[j].label||'').trim()||'(sans nom)';
      var key2='expense_'+lbl2;
      if(!expLabels[key2]) expLabels[key2]={label:lbl2,months:new Array(12).fill(0)};
      expLabels[key2].months[m2]+=(parseFloat(exp[j].amount)||0);
    }
  }

  var varLabels={};
  for(var m3=0;m3<12;m3++){
    var ve=yd.months[m3].variableExpenses;
    for(var v=0;v<ve.length;v++){
      var lbl3=(ve[v].label||'').trim()||'(sans nom)';
      var key3='var_'+lbl3;
      if(!varLabels[key3]) varLabels[key3]={label:lbl3,months:new Array(12).fill(0)};
      varLabels[key3].months[m3]+=(parseFloat(ve[v].actual)||0);
    }
  }

  var annualLabels={};
  var annuals=yd.annualExpenses;
  for(var a=0;a<annuals.length;a++){
    var lbl4=(annuals[a].label||'').trim()||'(sans nom)';
    var key4='annual_'+lbl4;
    if(!annualLabels[key4]) annualLabels[key4]={label:lbl4,months:new Array(12).fill(0)};
    var am=annuals[a].month;
    annualLabels[key4].months[am]+=(parseFloat(annuals[a].preleve)||0);
  }

  var savLabels={};
  for(var m4=0;m4<12;m4++){
    var sl=yd.months[m4].savingsLines;
    for(var s=0;s<sl.length;s++){
      var lbl5=(sl[s].label||'').trim()||'(sans nom)';
      var key5='sav_'+lbl5;
      if(!savLabels[key5]) savLabels[key5]={label:lbl5,months:new Array(12).fill(0)};
      savLabels[key5].months[m4]+=(parseFloat(sl[s].amount)||0);
    }
  }

  function pushCategory(obj, catName, catType, icon){
    var keys=Object.keys(obj).sort();
    for(var k=0;k<keys.length;k++){
      var it=obj[keys[k]];
      var total=it.months.reduce(function(s,v2){return s+v2},0);
      if(total===0 && it.months.every(function(v3){return v3===0})) continue;
      items.push({label:it.label,category:catName,type:catType,icon:icon,months:it.months,total:total,avg:total/12});
    }
  }

  pushCategory(incomeLabels,'Revenus','income','fa-arrow-down');
  pushCategory(expLabels,'Dépenses fixes','expense','fa-arrow-up');
  pushCategory(varLabels,'Dépenses variables','expense','fa-shuffle');
  pushCategory(annualLabels,'Dépenses annuelles','expense','fa-calendar-alt');
  pushCategory(savLabels,'Épargne','expense','fa-piggy-bank');

  var filtered=items;
  if(recapFilter==='income') filtered=items.filter(function(it){return it.type==='income'});
  else if(recapFilter==='expense') filtered=items.filter(function(it){return it.type==='expense'});

  var totalIn=0,totalOut=0;
  for(var t=0;t<items.length;t++){
    if(items[t].type==='income') totalIn+=items[t].total;
    else totalOut+=items[t].total;
  }
  var totalBal=totalIn-totalOut;

  var h='<div class="recap-summary">';
  h+='<div class="summary-card income"><div class="label">Total entrées</div><div class="value">'+fmt(totalIn)+'</div></div>';
  h+='<div class="summary-card expense"><div class="label">Total sorties</div><div class="value">'+fmt(totalOut)+'</div></div>';
  h+='<div class="summary-card balance"><div class="label">Solde annuel</div><div class="value '+(totalBal>=0?'positive':'negative')+'">'+fmt(totalBal)+'</div></div>';
  h+='<div class="summary-card"><div class="label">Nb intitulés</div><div class="value" style="color:var(--recap)">'+items.length+'</div></div>';
  h+='</div>';

  h+='<div class="section">';
  h+='<div class="section-header"><div class="section-title"><span class="icon recap-icon"><i class="fas fa-table-list"></i></span>Récapitulatif annuel</div></div>';

  h+='<div class="recap-filter-bar">';
  h+='<button class="recap-filter-btn'+(recapFilter==='all'?' active':'')+'" onclick="setRecapFilter(\'all\')">Tout</button>';
  h+='<button class="recap-filter-btn'+(recapFilter==='income'?' active':'')+'" onclick="setRecapFilter(\'income\')"><i class="fas fa-arrow-down"></i> Entrées</button>';
  h+='<button class="recap-filter-btn'+(recapFilter==='expense'?' active':'')+'" onclick="setRecapFilter(\'expense\')"><i class="fas fa-arrow-up"></i> Sorties</button>';
  h+='</div>';

  if(filtered.length===0){
    h+='<div class="empty-state"><i class="fas fa-table"></i><p>Aucune donnée à afficher.</p></div>';
  } else {
    h+='<div style="overflow-x:auto">';
    h+='<table class="recap-table"><thead><tr><th>Catégorie</th><th>Intitulé</th>';
    for(var mi=0;mi<12;mi++) h+='<th>'+MONTHS_SHORT[mi]+'</th>';
    h+='<th>Total</th><th>Moy.</th></tr></thead><tbody>';

    var lastCat='';
    var ftIn=0,ftOut=0;
    var monthTotals=new Array(12).fill(0);

    for(var f=0;f<filtered.length;f++){
      var it2=filtered[f];
      if(it2.category!==lastCat){
        lastCat=it2.category;
        h+='<tr class="recap-section-row"><td colspan="'+(14)+'"><i class="fas '+it2.icon+'"></i> '+escapeHtml(lastCat)+'</td></tr>';
      }
      h+='<tr>';
      h+='<td style="font-size:11px;color:var(--text-muted)">'+escapeHtml(it2.category)+'</td>';
      h+='<td><span class="recap-label-icon"><i class="fas '+it2.icon+'" style="color:'+(it2.type==='income'?'var(--green)':'var(--red)')+'"></i> '+escapeHtml(it2.label)+'</span></td>';
      for(var mc=0;mc<12;mc++){
        var val=it2.months[mc];
        var cls=val>0?(it2.type==='income'?'val-positive':'val-negative'):'val-zero';
        h+='<td class="'+cls+'">'+(val!==0?fmt(val):'—')+'</td>';
        if(it2.type==='income') monthTotals[mc]+=val;
        else monthTotals[mc]-=val;
      }
      if(it2.type==='income') ftIn+=it2.total; else ftOut+=it2.total;
      var totalCls=it2.type==='income'?'val-positive':'val-negative';
      h+='<td class="'+totalCls+'" style="font-weight:800">'+fmt(it2.total)+'</td>';
      h+='<td class="recap-avg">'+fmt(it2.avg)+'</td>';
      h+='</tr>';
    }

    var ftBal=ftIn-ftOut;
    h+='</tbody><tfoot><tr><td></td><td style="font-weight:800">Solde net</td>';
    for(var mf=0;mf<12;mf++){
      var mCls=monthTotals[mf]>=0?'val-positive':'val-negative';
      h+='<td class="'+mCls+'">'+fmt(monthTotals[mf])+'</td>';
    }
    var balCls=ftBal>=0?'val-positive':'val-negative';
    h+='<td class="'+balCls+'">'+fmt(ftBal)+'</td>';
    h+='<td class="recap-avg">'+fmt(ftBal/12)+'</td>';
    h+='</tr></tfoot></table></div>';
  }
  h+='</div>';

  document.getElementById('mainContent').innerHTML=h;
}

function setRecapFilter(f){recapFilter=f;renderRecapPage()}

// ===== LABEL CHANGE WITH SCOPE CHOICE =====
function handleLabelChange(type,m,idx,newVal){
  showScopeDialog(
    'Renommer l\'intitulé',
    'Appliquer le nouveau nom « '+escapeHtml(newVal)+' » à :',
    function(){
      initYearData();var yd=data[getYearKey()];
      for(var i=0;i<12;i++){if(yd.months[i][type]&&yd.months[i][type][idx])yd.months[i][type][idx].label=newVal}
      saveToStorage();renderTabs();renderContent();
      showToast('fa-check-circle','Intitulé renommé (toute l\'année)');
    },
    function(){
      initYearData();
      var arr=data[getYearKey()].months[m][type];
      if(arr&&arr[idx]) arr[idx].label=newVal;
      saveToStorage();renderTabs();renderContent();
      showToast('fa-check-circle','Intitulé renommé ('+MONTHS[m]+' seul)');
    },
    m
  );
}

// ===== ADD ROW =====
function addRowYear(type,m){
  initYearData();var yd=data[getYearKey()];
  var isVar=type==='variableExpenses';
  for(var i=0;i<12;i++){
    if(isVar) yd.months[i][type].push({label:'',forecast:0,actual:0});
    else yd.months[i][type].push({label:'',amount:0});
  }
  saveToStorage();renderContent();
  focusLastInput(isVar);
  showToast('fa-plus-circle','Ligne ajoutée (toute l\'année)');
}

function addRowMonth(type,m){
  initYearData();var yd=data[getYearKey()];
  var isVar=type==='variableExpenses';
  if(isVar) yd.months[m][type].push({label:'',forecast:0,actual:0});
  else yd.months[m][type].push({label:'',amount:0});
  saveToStorage();renderContent();
  focusLastInput(isVar);
  showToast('fa-plus-circle','Ligne ajoutée ('+MONTHS[m]+' seul)');
}

function focusLastInput(isVar){
  var sel=isVar?'.var-row .row-label input':'.budget-row .row-label input';
  var rows=document.querySelectorAll(sel);
  if(rows.length>0)rows[rows.length-1].focus();
}

// ===== DELETE ROW WITH SCOPE CHOICE =====
function handleDeleteRow(type,m,idx){
  var label=gM(m)[type][idx].label||'cette ligne';
  showDeleteScopeDialog(
    'Supprimer « '+escapeHtml(label)+' »',
    'Supprimer de :',
    function(){
      initYearData();var yd=data[getYearKey()];
      for(var i=0;i<12;i++){if(yd.months[i][type]&&yd.months[i][type].length>idx)yd.months[i][type].splice(idx,1)}
      saveToStorage();renderTabs();renderContent();
      showToast('fa-trash','Supprimé (toute l\'année)');
    },
    function(){
      initYearData();var yd=data[getYearKey()];
      if(yd.months[m][type]&&yd.months[m][type].length>idx)yd.months[m][type].splice(idx,1);
      saveToStorage();renderTabs();renderContent();
      showToast('fa-trash','Supprimé ('+MONTHS[m]+' seul)');
    },
    m
  );
}

function moveRow(type,m,idx,dir){
  initYearData();var yd=data[getYearKey()];var newIdx=idx+dir;
  if(type==='annual'){
    var arr=yd.annualExpenses;if(newIdx<0||newIdx>=arr.length)return;
    var tmp=arr[idx];arr[idx]=arr[newIdx];arr[newIdx]=tmp;
  } else if(type==='savingsLines'){
    var sArr=yd.months[m].savingsLines;if(newIdx<0||newIdx>=sArr.length)return;
    var st=sArr[idx];sArr[idx]=sArr[newIdx];sArr[newIdx]=st;
  } else {
    for(var i=0;i<12;i++){
      var arr2=yd.months[i][type];
      if(!arr2||newIdx<0||newIdx>=arr2.length)continue;
      var t2=arr2[idx];arr2[idx]=arr2[newIdx];arr2[newIdx]=t2;
    }
  }
  saveToStorage();renderContent();
}
function updateAmount(type,m,idx,val){gM(m)[type][idx].amount=parseFloat(val)||0;saveToStorage();renderTabs();renderContent()}
function updateVarAmount(m,idx,field,val){gM(m).variableExpenses[idx][field]=parseFloat(val)||0;saveToStorage();renderTabs();renderContent()}

// ===== SAVINGS LINES =====
function addSavingsLine(m){
  initYearData();
  var md=data[getYearKey()].months[m];
  md.savingsLines.push({label:'',amount:0});
  saveToStorage();renderTabs();renderContent();
  var rows=document.querySelectorAll('.savings-line-row .compte-select');
  if(rows.length>0)rows[rows.length-1].focus();
}
function updateSavingsLineLabel(m,idx,val){
  gM(m).savingsLines[idx].label=val;
  saveToStorage();renderTabs();renderContent();
}
function updateSavingsLineAmount(m,idx,val){
  gM(m).savingsLines[idx].amount=parseFloat(val)||0;
  saveToStorage();renderTabs();renderContent();
}
function deleteSavingsLine(m,idx){
  var label=gM(m).savingsLines[idx].label||'cette ligne';
  showConfirmDialog('Supprimer « '+escapeHtml(label)+' » ?','Cette ligne d\'épargne sera supprimée pour '+MONTHS[m]+'.',function(){
    gM(m).savingsLines.splice(idx,1);
    saveToStorage();renderTabs();renderContent();
    showToast('fa-trash','Ligne d\'épargne supprimée');
  });
}

// ===== ANNUAL EXPENSES =====
function updateGoal(val){sSG(val);saveToStorage();renderContent()}
function updateAnnualLabel(idx,val){gAE()[idx].label=val;saveToStorage()}
function updateAnnualPrevu(idx,val){gAE()[idx].prevu=parseFloat(val)||0;saveToStorage();renderTabs();renderContent()}
function updateAnnualPreleve(idx,val){gAE()[idx].preleve=parseFloat(val)||0;saveToStorage();renderTabs();renderContent()}
function updateAnnualMonth(idx,val){gAE()[idx].month=parseInt(val,10);saveToStorage();renderTabs();renderContent()}
function updateAnnualCompte(idx,val){gAE()[idx].compte=val;saveToStorage();renderContent()}
function addAnnualExpense(){gAE().push({label:'',prevu:0,preleve:0,month:0,compte:''});saveToStorage();renderContent();var r=document.querySelectorAll('.annual-row .row-label input');if(r.length>0)r[r.length-1].focus()}
function deleteAnnualExpense(idx){showConfirmDialog('Supprimer cette dépense annuelle ?','Elle sera retirée du mois correspondant.',function(){gAE().splice(idx,1);saveToStorage();renderTabs();renderContent()})}

// ===== YEAR =====
function changeYear(d){currentYear+=d;document.getElementById('yearDisplay').textContent=currentYear;initYearData();renderTabs();renderContent()}

// ===== EXPORT / IMPORT =====
function exportData(){var b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='budget_'+currentYear+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);showToast('fa-check-circle','Données exportées')}
function triggerImport(){document.getElementById('fileInput').click()}
function importData(event){var f=event.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(e){try{var imp=JSON.parse(e.target.result);if(typeof imp==='object'&&imp!==null){data=imp;var k=Object.keys(data);if(k.length>0){currentYear=parseInt(k[0].substring(1),10);document.getElementById('yearDisplay').textContent=currentYear}saveToStorage();renderTabs();renderContent();showToast('fa-check-circle','Données importées')}}catch(err){showToast('fa-exclamation-triangle','Fichier invalide')}};r.readAsText(f);event.target.value=''}
function showResetConfirm(){showConfirmDialog('Réinitialiser ?','Données de '+currentYear+' effacées.',function(){delete data[getYearKey()];initYearData();saveToStorage();renderTabs();renderContent();showToast('fa-rotate-left','Données réinitialisées')})}

// ===== MODAL / TOAST =====
function showConfirmDialog(title,msg,cb){
  var o=document.getElementById('modalOverlay'),c=document.getElementById('modalContent');
  c.innerHTML='<h3>'+escapeHtml(title)+'</h3><p>'+escapeHtml(msg)+'</p><div class="modal-actions"><button class="modal-btn cancel" id="mC">Annuler</button><button class="modal-btn confirm" id="mK">Confirmer</button></div>';
  o.classList.add('show');
  document.getElementById('mC').onclick=function(){o.classList.remove('show')};
  document.getElementById('mK').onclick=function(){o.classList.remove('show');cb()};
  o.onclick=function(e){if(e.target===o)o.classList.remove('show')};
}

function showScopeDialog(title,msg,cbYear,cbMonth,m){
  var o=document.getElementById('modalOverlay'),c=document.getElementById('modalContent');
  c.innerHTML='<h3>'+title+'</h3><p>'+msg+'</p><div class="modal-actions">'
    +'<button class="modal-btn cancel" id="mC">Annuler</button>'
    +'<button class="modal-btn secondary" id="mMonth"><i class="fas fa-calendar-day"></i> '+MONTHS_SHORT[m]+' seul</button>'
    +'<button class="modal-btn primary" id="mYear"><i class="fas fa-calendar-alt"></i> Toute l\'année</button>'
    +'</div>';
  o.classList.add('show');
  document.getElementById('mC').onclick=function(){o.classList.remove('show')};
  document.getElementById('mMonth').onclick=function(){o.classList.remove('show');cbMonth()};
  document.getElementById('mYear').onclick=function(){o.classList.remove('show');cbYear()};
  o.onclick=function(e){if(e.target===o)o.classList.remove('show')};
}

function showDeleteScopeDialog(title,msg,cbYear,cbMonth,m){
  var o=document.getElementById('modalOverlay'),c=document.getElementById('modalContent');
  c.innerHTML='<h3>'+title+'</h3><p>'+msg+'</p><div class="modal-actions">'
    +'<button class="modal-btn cancel" id="mC">Annuler</button>'
    +'<button class="modal-btn secondary" id="mMonth"><i class="fas fa-calendar-day"></i> '+MONTHS_SHORT[m]+' seul</button>'
    +'<button class="modal-btn confirm" id="mYear"><i class="fas fa-calendar-alt"></i> Toute l\'année</button>'
    +'</div>';
  o.classList.add('show');
  document.getElementById('mC').onclick=function(){o.classList.remove('show')};
  document.getElementById('mMonth').onclick=function(){o.classList.remove('show');cbMonth()};
  document.getElementById('mYear').onclick=function(){o.classList.remove('show');cbYear()};
  o.onclick=function(e){if(e.target===o)o.classList.remove('show')};
}

function showToast(icon,msg){var t=document.getElementById('toast');t.querySelector('.toast-icon').className='toast-icon fas '+icon;t.querySelector('.toast-text').textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2500)}

// ===== UTILS =====
function escapeHtml(s){var d=document.createElement('div');d.appendChild(document.createTextNode(s));return d.innerHTML}
function escapeAttr(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ===== INIT =====
var didLoad=loadFromStorage();
if(didLoad){var sk=Object.keys(data);if(sk.length>0){var yrs=sk.map(function(k){return parseInt(k.substring(1),10)}).sort();currentYear=yrs[yrs.length-1];document.getElementById('yearDisplay').textContent=currentYear}}
initYearData();renderTabs();renderContent();
</script>
</body>
</html>
