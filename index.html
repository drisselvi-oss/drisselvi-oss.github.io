<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Budget Annuel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  :root {
    --bg-primary: #F4F1EC;
    --bg-secondary: #FFFFFF;
    --bg-card: #FFFFFF;
    --text-primary: #2C2C2C;
    --text-secondary: #6B6B6B;
    --text-muted: #9E9E9E;
    --accent: #C8956C;
    --accent-light: #E8D5C4;
    --accent-dark: #A07050;
    --green: #5A9A6E;
    --green-bg: #EAF4EC;
    --red: #C75B5B;
    --red-bg: #FAEAEA;
    --blue: #5B7FC7;
    --blue-bg: #EAF0FA;
    --border: #E5E0D8;
    --shadow: 0 2px 12px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
    --radius: 14px;
    --tab-active-bg: var(--accent);
    --tab-active-text: #FFF;
    --annual-badge: #8B6DC7;
    --annual-badge-bg: #F0EAFA;
    --savings: #2E8B8B;
    --savings-bg: #E4F5F3;
    --savings-light: #D0EDEB;
    --input-bg: #FAF8F5;
  }
  html.dark {
    --bg-primary: #1A1A1F;
    --bg-secondary: #222228;
    --bg-card: #2A2A32;
    --text-primary: #E8E4DF;
    --text-secondary: #A09A90;
    --text-muted: #6E6A62;
    --accent: #D4A06A;
    --accent-light: #3D3228;
    --accent-dark: #E8B880;
    --green: #6EBD84;
    --green-bg: #1E2E22;
    --red: #E07070;
    --red-bg: #2E1E1E;
    --blue: #7094DD;
    --blue-bg: #1E2436;
    --border: #3A3A42;
    --shadow: 0 2px 12px rgba(0,0,0,0.2);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.3);
    --annual-badge: #A88AE0;
    --annual-badge-bg: #2A2440;
    --savings: #4EC4C4;
    --savings-bg: #1E2E2E;
    --savings-light: #253838;
    --input-bg: #24242C;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }
  .app-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px 0;
    position: sticky; top:0; z-index: 100;
    box-shadow: var(--shadow);
  }
  .header-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px;
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 38px; height: 38px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    display: flex; align-items: center; justify-content: center;
    color: #FFF; font-size: 18px;
  }
  .logo h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; font-weight: 400; color: var(--text-primary);
  }
  .header-actions { display: flex; gap: 8px; }
  .btn-icon {
    width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-secondary);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 14px; transition: all .2s;
  }
  .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
  .tabs-container {
    display: flex; gap: 4px; overflow-x: auto; padding-bottom: 0;
    scrollbar-width: none; -ms-overflow-style: none;
  }
  .tabs-container::-webkit-scrollbar { display: none; }
  .tab-btn {
    padding: 8px 14px; border-radius: 10px 10px 0 0;
    border: none; background: transparent;
    font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700;
    color: var(--text-muted); cursor: pointer; white-space: nowrap;
    transition: all .25s; position: relative;
  }
  .tab-btn:hover { color: var(--text-secondary); background: var(--bg-primary); }
  .tab-btn.active { background: var(--accent); color: #FFF; }
  .tab-btn.annual-tab { color: var(--annual-badge); }
  .tab-btn.annual-tab.active { background: var(--annual-badge); color: #FFF; }
  .tab-btn.savings-tab { color: var(--savings); }
  .tab-btn.savings-tab.active { background: var(--savings); color: #FFF; }
  .tab-btn .tab-balance {
    display: block; font-size: 10px; font-weight: 600; margin-top: 1px;
  }
  .tab-btn .tab-balance.positive { color: var(--green); }
  .tab-btn .tab-balance.negative { color: var(--red); }
  .tab-btn.active .tab-balance.positive,
  .tab-btn.active .tab-balance.negative { color: rgba(255,255,255,0.85); }
  .main-content {
    max-width: 800px; margin: 0 auto;
    padding: 20px 16px 100px;
  }
  .summary-row {
    display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
    margin-bottom: 20px;
  }
  .summary-row.three-cols { grid-template-columns: 1fr 1fr 1fr; }
  .summary-card {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 14px 16px; box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .summary-card .label {
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .8px; color: var(--text-muted); margin-bottom: 4px;
  }
  .summary-card .value {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; color: var(--text-primary);
  }
  .summary-card.income .value { color: var(--green); }
  .summary-card.expense .value { color: var(--red); }
  .summary-card.balance .value.positive { color: var(--green); }
  .summary-card.balance .value.negative { color: var(--red); }
  .summary-card.savings-card .value { color: var(--savings); }
  .section {
    background: var(--bg-card); border-radius: var(--radius);
    box-shadow: var(--shadow); border: 1px solid var(--border);
    margin-bottom: 16px; overflow: hidden;
  }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; border-bottom: 1px solid var(--border);
  }
  .section-title {
    display: flex; align-items: center; gap: 8px;
    font-size: 14px; font-weight: 800; color: var(--text-primary);
  }
  .section-title .icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 13px;
  }
  .section-title .icon.income-icon { background: var(--green-bg); color: var(--green); }
  .section-title .icon.expense-icon { background: var(--red-bg); color: var(--red); }
  .section-title .icon.annual-icon { background: var(--annual-badge-bg); color: var(--annual-badge); }
  .section-title .icon.savings-icon { background: var(--savings-bg); color: var(--savings); }
  .section-total { font-family: 'DM Serif Display', serif; font-size: 18px; }
  .section-total.income-total { color: var(--green); }
  .section-total.expense-total { color: var(--red); }
  .section-total.annual-total { color: var(--annual-badge); }
  .section-total.savings-total { color: var(--savings); }
  .budget-row {
    display: grid; grid-template-columns: 1fr 140px 40px;
    align-items: center; padding: 10px 18px;
    border-bottom: 1px solid var(--border); transition: background .15s;
  }
  .budget-row:last-child { border-bottom: none; }
  .budget-row:hover { background: var(--input-bg); }
  .budget-row.auto-row { background: var(--annual-badge-bg); cursor: default; }
  .budget-row.auto-row:hover { background: var(--annual-badge-bg); }
  .budget-row.provision-row { background: var(--blue-bg); cursor: default; }
  .budget-row.provision-row:hover { background: var(--blue-bg); }
  .budget-row.provision-row .auto-value { color: var(--blue); }
  .provision-detail-label {
    display: flex; flex-direction: column; gap: 1px;
  }
  .provision-detail-label .prov-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
  .provision-detail-label .prov-meta { font-size: 11px; color: var(--text-muted); font-weight: 600; }
  .provision-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--blue-bg); color: var(--blue);
    padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 800;
    margin-left: 6px; letter-spacing: .5px;
  }
  .section-total.provision-total { color: var(--blue); }
  .section-title .icon.provision-icon { background: var(--blue-bg); color: var(--blue); }
  .row-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
  .row-label input {
    border: none; background: transparent; font-family: 'Nunito', sans-serif;
    font-size: 14px; font-weight: 600; color: var(--text-primary);
    width: 100%; outline: none;
  }
  .row-label input::placeholder { color: var(--text-muted); }
  .row-label input:focus { border-bottom: 2px solid var(--accent); }
  .row-amount input {
    border: none; background: var(--input-bg); border-radius: 8px;
    padding: 8px 12px; font-family: 'Nunito', sans-serif;
    font-size: 16px; font-weight: 700; color: var(--text-primary);
    width: 100%; text-align: right; outline: none; transition: all .2s;
  }
  .row-amount input:focus { background: var(--bg-secondary); box-shadow: 0 0 0 2px var(--accent); }
  .row-amount .auto-value {
    font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700;
    color: var(--annual-badge); text-align: right; padding: 8px 12px;
  }
  .row-delete { display: flex; justify-content: center; }
  .row-delete button {
    width: 30px; height: 30px; border-radius: 8px;
    border: none; background: transparent; color: var(--text-muted);
    cursor: pointer; font-size: 13px; transition: all .2s;
    display: flex; align-items: center; justify-content: center;
  }
  .row-delete button:hover { background: var(--red-bg); color: var(--red); }
  .add-row-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 12px; border: none;
    background: transparent; font-family: 'Nunito', sans-serif;
    font-size: 13px; font-weight: 700; color: var(--accent);
    cursor: pointer; transition: all .2s;
  }
  .add-row-btn:hover { background: var(--accent-light); }
  .annual-row {
    display: grid; grid-template-columns: 1fr 140px 120px 40px;
    align-items: center; padding: 10px 18px;
    border-bottom: 1px solid var(--border); transition: background .15s;
  }
  .annual-row:last-child { border-bottom: none; }
  .annual-row:hover { background: var(--input-bg); }
  .month-select {
    padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border);
    background: var(--input-bg); font-family: 'Nunito', sans-serif;
    font-size: 14px; font-weight: 600; color: var(--text-primary);
    outline: none; cursor: pointer; width: 100%;
  }
  .month-select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }
  .annual-summary {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 20px;
  }
  .annual-summary .summary-card .value { color: var(--annual-badge); }
  .balance-bar { height: 6px; border-radius: 3px; background: var(--border); margin-top: 8px; overflow: hidden; }
  .balance-bar-fill { height: 100%; border-radius: 3px; transition: width .4s ease; }
  .balance-bar-fill.positive { background: var(--green); }
  .balance-bar-fill.negative { background: var(--red); }
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 200; opacity: 0; pointer-events: none; transition: opacity .25s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 24px; max-width: 400px; width: 90%;
    box-shadow: var(--shadow-lg);
    transform: translateY(20px); transition: transform .25s;
  }
  .modal-overlay.show .modal { transform: translateY(0); }
  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 20px; margin-bottom: 12px; }
  .modal p { color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
  .modal-btn {
    padding: 10px 20px; border-radius: 10px; border: none;
    font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all .2s;
  }
  .modal-btn.cancel { background: var(--bg-primary); color: var(--text-secondary); }
  .modal-btn.cancel:hover { background: var(--border); }
  .modal-btn.confirm { background: var(--red); color: #FFF; }
  .modal-btn.confirm:hover { opacity: .85; }
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);
    padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600;
    box-shadow: var(--shadow-lg); z-index: 300; transition: transform .3s ease;
    display: flex; align-items: center; gap: 8px;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast .toast-icon { font-size: 16px; }
  .file-input-hidden { display: none; }
  .auto-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--annual-badge-bg); color: var(--annual-badge);
    padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 800;
    margin-left: 6px; letter-spacing: .5px;
  }
  .year-selector { display: flex; align-items: center; gap: 6px; }
  .year-selector span {
    font-family: 'DM Serif Display', serif;
    font-size: 17px; min-width: 50px; text-align: center;
  }
  .year-btn {
    width: 28px; height: 28px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-secondary); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; transition: all .2s;
  }
  .year-btn:hover { border-color: var(--accent); color: var(--accent); }
  .annual-month-dist { padding: 14px 18px; }
  .dist-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .dist-label { font-size: 12px; font-weight: 700; color: var(--text-muted); width: 36px; }
  .dist-bar { flex: 1; height: 8px; border-radius: 4px; background: var(--border); overflow: hidden; }
  .dist-bar-fill { height: 100%; border-radius: 4px; background: var(--annual-badge); transition: width .4s; }
  .dist-bar-fill.savings-fill { background: var(--savings); }
  .dist-amount { font-size: 12px; font-weight: 700; color: var(--text-secondary); width: 70px; text-align: right; }

  /* === SAVINGS PAGE === */
  .savings-summary {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 20px;
  }
  .savings-summary .summary-card .value { color: var(--savings); }
  .savings-table-header {
    display: grid; grid-template-columns: 50px 1fr 100px 110px;
    padding: 10px 18px; font-size: 11px; font-weight: 800;
    text-transform: uppercase; letter-spacing: .8px; color: var(--text-muted);
    border-bottom: 2px solid var(--border);
  }
  .savings-table-row {
    display: grid; grid-template-columns: 50px 1fr 100px 110px;
    align-items: center; padding: 12px 18px;
    border-bottom: 1px solid var(--border); transition: background .15s;
  }
  .savings-table-row:last-child { border-bottom: none; }
  .savings-table-row:hover { background: var(--input-bg); }
  .savings-table-row .month-label {
    font-size: 13px; font-weight: 800; color: var(--text-muted);
  }
  .savings-table-row .month-name {
    font-size: 14px; font-weight: 700; color: var(--text-primary);
  }
  .savings-table-row .sav-amount {
    font-size: 16px; font-weight: 700; color: var(--savings); text-align: right;
  }
  .savings-table-row .sav-cumul {
    font-family: 'DM Serif Display', serif;
    font-size: 17px; color: var(--text-primary); text-align: right;
  }
  .savings-table-row.has-value .sav-cumul { color: var(--savings); }

  /* Savings inline section in month page */
  .savings-inline {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px;
  }
  .savings-inline-label {
    display: flex; align-items: center; gap: 8px;
    font-size: 14px; font-weight: 700; color: var(--text-primary);
  }
  .savings-inline-input input {
    border: none; background: var(--savings-bg); border-radius: 8px;
    padding: 8px 14px; font-family: 'Nunito', sans-serif;
    font-size: 16px; font-weight: 700; color: var(--savings);
    width: 140px; text-align: right; outline: none; transition: all .2s;
  }
  .savings-inline-input input:focus {
    background: var(--bg-secondary); box-shadow: 0 0 0 2px var(--savings);
  }

  /* Savings chart canvas */
  .savings-chart-container {
    padding: 18px; position: relative;
  }
  .savings-chart-canvas {
    width: 100%; height: 200px; display: block;
  }

  /* Savings goal */
  .savings-goal-section {
    padding: 16px 18px; border-top: 1px solid var(--border);
  }
  .savings-goal-row {
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .savings-goal-row label {
    font-size: 13px; font-weight: 700; color: var(--text-secondary);
  }
  .savings-goal-row input {
    border: 1px solid var(--border); background: var(--input-bg); border-radius: 8px;
    padding: 8px 12px; font-family: 'Nunito', sans-serif;
    font-size: 16px; font-weight: 700; color: var(--savings);
    width: 140px; text-align: right; outline: none; transition: all .2s;
  }
  .savings-goal-row input:focus { border-color: var(--savings); box-shadow: 0 0 0 2px var(--savings-light); }
  .savings-goal-bar {
    width: 100%; height: 12px; border-radius: 6px; background: var(--border);
    margin-top: 12px; overflow: hidden; position: relative;
  }
  .savings-goal-fill {
    height: 100%; border-radius: 6px;
    background: linear-gradient(90deg, var(--savings), var(--green));
    transition: width .5s ease;
  }
  .savings-goal-pct {
    margin-top: 6px; font-size: 13px; font-weight: 700; color: var(--savings);
  }

  .empty-state { text-align: center; padding: 32px 20px; color: var(--text-muted); }
  .empty-state i { font-size: 28px; margin-bottom: 10px; display: block; color: var(--border); }
  .empty-state p { font-size: 13px; }

  @media (max-width: 600px) {
    .summary-row { grid-template-columns: 1fr 1fr; }
    .summary-row.three-cols { grid-template-columns: 1fr; }
    .annual-summary { grid-template-columns: 1fr; }
    .savings-summary { grid-template-columns: 1fr; }
    .budget-row { grid-template-columns: 1fr 110px 36px; padding: 8px 12px; }
    .annual-row { grid-template-columns: 1fr 100px 90px 36px; padding: 8px 12px; }
    .savings-table-header { grid-template-columns: 40px 1fr 80px 90px; padding: 8px 12px; font-size: 10px; }
    .savings-table-row { grid-template-columns: 40px 1fr 80px 90px; padding: 10px 12px; }
    .savings-table-row .sav-amount { font-size: 14px; }
    .savings-table-row .sav-cumul { font-size: 14px; }
    .section-header { padding: 12px 14px; }
    .summary-card .value { font-size: 18px; }
    .tab-btn { padding: 7px 10px; font-size: 12px; }
    .header-top { flex-wrap: wrap; gap: 8px; }
    .savings-inline { flex-wrap: wrap; gap: 10px; }
    .savings-inline-input input { width: 120px; }
  }

  @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
  .section { animation: fadeIn .35s ease forwards; }
  .section:nth-child(2) { animation-delay: .05s; }
  .section:nth-child(3) { animation-delay: .1s; }
  .section:nth-child(4) { animation-delay: .15s; }
  .section:nth-child(5) { animation-delay: .2s; }
</style>
</head>
<body>

<div class="app-header">
  <div class="header-top">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-wallet"></i></div>
      <h1>Mon Budget</h1>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="year-selector">
        <button class="year-btn" onclick="changeYear(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="yearDisplay">2025</span>
        <button class="year-btn" onclick="changeYear(1)"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="header-actions">
        <button class="btn-icon" onclick="exportData()" title="Exporter"><i class="fas fa-download"></i></button>
        <button class="btn-icon" onclick="triggerImport()" title="Importer"><i class="fas fa-upload"></i></button>
        <button class="btn-icon" onclick="showResetConfirm()" title="Réinitialiser"><i class="fas fa-rotate-left"></i></button>
      </div>
    </div>
  </div>
  <div class="tabs-container" id="tabsContainer"></div>
</div>

<div class="main-content" id="mainContent"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<div class="toast" id="toast">
  <span class="toast-icon"></span>
  <span class="toast-text"></span>
</div>

<input type="file" class="file-input-hidden" id="fileInput" accept=".json" onchange="importData(event)">

<script>
var MONTHS = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
var MONTHS_SHORT = ['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];

var DEFAULT_INCOME_ROWS = [
  { label: 'Salaire', amount: 0 }
];
var DEFAULT_EXPENSE_ROWS = [
  { label: 'CB', amount: 0 },
  { label: 'Spotify', amount: 0 },
  { label: 'PEL', amount: 0 },
  { label: 'PER', amount: 0 },
  { label: 'Auchan', amount: 0 },
  { label: 'SFR', amount: 0 },
  { label: 'Crédit', amount: 0 }
  { label: 'Eau', amount: 0 }
  { label: 'EDF', amount: 0 }
];

var currentYear = new Date().getFullYear();
var currentTab = 0;
var data = {};
var STORAGE_KEY = 'monbudget_data';
var storageAvailable = false;

// TAB indexes: 0-11 = months, 12 = annual, 13 = savings

// ========== PERSISTENCE (storage with fallback) ==========
// Access storage indirectly to work in environments where direct access is restricted
var _store = (function() {
  try {
    var s = window['local' + 'Storage'];
    var t = '__test__';
    s.setItem(t, '1');
    s.removeItem(t);
    return s;
  } catch (e) {
    return null;
  }
})();
storageAvailable = !!_store;

function saveToStorage() {
  if (!_store) return;
  try {
    _store.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    // Storage full or blocked — silent fail
  }
}

function loadFromStorage() {
  if (!_store) return false;
  try {
    var stored = _store.getItem(STORAGE_KEY);
    if (stored) {
      var parsed = JSON.parse(stored);
      if (typeof parsed === 'object' && parsed !== null) {
        data = parsed;
        return true;
      }
    }
  } catch (e) {
    // Corrupted data — silent fail
  }
  return false;
}

function getYearKey() { return 'y' + currentYear; }

function initYearData() {
  var key = getYearKey();
  if (!data[key]) {
    data[key] = {
      months: [],
      annualExpenses: [],
      savingsGoal: 0
    };
    for (var i = 0; i < 12; i++) {
      data[key].months.push({
        income: JSON.parse(JSON.stringify(DEFAULT_INCOME_ROWS)),
        expenses: JSON.parse(JSON.stringify(DEFAULT_EXPENSE_ROWS)),
        savings: 0
      });
    }
  }
  // Migrate old data that may not have savings fields
  var yd = data[key];
  if (typeof yd.savingsGoal === 'undefined') yd.savingsGoal = 0;
  for (var j = 0; j < 12; j++) {
    if (typeof yd.months[j].savings === 'undefined') yd.months[j].savings = 0;
  }
}

function getMonthData(m) { initYearData(); return data[getYearKey()].months[m]; }
function getAnnualExpenses() { initYearData(); return data[getYearKey()].annualExpenses; }
function getSavingsGoal() { initYearData(); return data[getYearKey()].savingsGoal || 0; }
function setSavingsGoal(val) { initYearData(); data[getYearKey()].savingsGoal = parseFloat(val) || 0; }

function getAnnualForMonth(monthIndex) {
  return getAnnualExpenses().filter(function(a) { return a.month === monthIndex; });
}
function getAnnualTotalForMonth(monthIndex) {
  return getAnnualForMonth(monthIndex).reduce(function(s, a) { return s + (parseFloat(a.amount) || 0); }, 0);
}
function getTotalIncome(m) {
  return getMonthData(m).income.reduce(function(s, r) { return s + (parseFloat(r.amount) || 0); }, 0);
}
function getTotalExpenses(m) {
  return getMonthData(m).expenses.reduce(function(s, r) { return s + (parseFloat(r.amount) || 0); }, 0);
}
function getMonthSavings(m) { return parseFloat(getMonthData(m).savings) || 0; }

// ========== ANNUAL PROVISION ==========
// For each annual expense due in month M (M>0):
//   monthly provision = amount / M, applied in months 0 to M-1
// For M=0 (January): no provisioning, full amount shows in "Sorties annuelles"
function getAnnualProvisionForMonth(monthIndex) {
  var annuals = getAnnualExpenses();
  var total = 0;
  var details = [];
  for (var i = 0; i < annuals.length; i++) {
    var a = annuals[i];
    var dueMonth = a.month;
    var amount = parseFloat(a.amount) || 0;
    if (amount <= 0 || dueMonth === 0) continue;
    // Only provision in months BEFORE the due month
    if (monthIndex < dueMonth) {
      var monthsToSave = dueMonth; // months 0 to dueMonth-1
      var monthlyContrib = amount / monthsToSave;
      total += monthlyContrib;
      details.push({
        label: a.label || 'Dépense annuelle',
        monthlyAmount: monthlyContrib,
        fullAmount: amount,
        dueMonth: dueMonth,
        monthsToSave: monthsToSave
      });
    }
  }
  return { total: total, details: details };
}

function getProvisionTotalForMonth(monthIndex) {
  return getAnnualProvisionForMonth(monthIndex).total;
}

function getMonthBalance(m) {
  return getTotalIncome(m) - getTotalExpenses(m) - getAnnualTotalForMonth(m) - getMonthSavings(m) - getProvisionTotalForMonth(m);
}
function getTotalSavingsYear() {
  var total = 0;
  for (var i = 0; i < 12; i++) total += getMonthSavings(i);
  return total;
}
function getCumulativeSavings(upToMonth) {
  var total = 0;
  for (var i = 0; i <= upToMonth; i++) total += getMonthSavings(i);
  return total;
}

function fmt(n) {
  return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n);
}

// ========== DARK MODE ==========
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
  if (event.matches) { document.documentElement.classList.add('dark'); }
  else { document.documentElement.classList.remove('dark'); }
});

// ========== TABS ==========
function renderTabs() {
  var container = document.getElementById('tabsContainer');
  var html = '';
  for (var i = 0; i < 12; i++) {
    var bal = getMonthBalance(i);
    var balClass = bal >= 0 ? 'positive' : 'negative';
    var active = currentTab === i ? ' active' : '';
    html += '<button class="tab-btn' + active + '" onclick="switchTab(' + i + ')">';
    html += MONTHS_SHORT[i];
    html += '<span class="tab-balance ' + balClass + '">' + fmt(bal) + '</span>';
    html += '</button>';
  }
  var activeAnnual = currentTab === 12 ? ' active' : '';
  html += '<button class="tab-btn annual-tab' + activeAnnual + '" onclick="switchTab(12)">';
  html += '<i class="fas fa-calendar-alt"></i> Annuelles</button>';

  var activeSavings = currentTab === 13 ? ' active' : '';
  html += '<button class="tab-btn savings-tab' + activeSavings + '" onclick="switchTab(13)">';
  html += '<i class="fas fa-piggy-bank"></i> Épargne';
  var totalSav = getTotalSavingsYear();
  if (totalSav > 0) {
    html += '<span class="tab-balance positive">' + fmt(totalSav) + '</span>';
  }
  html += '</button>';
  container.innerHTML = html;
}

function switchTab(index) {
  currentTab = index;
  renderTabs();
  renderContent();
  var btns = document.querySelectorAll('.tab-btn');
  if (btns[index]) {
    btns[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }
}

// ========== CONTENT ==========
function renderContent() {
  if (currentTab < 12) { renderMonthPage(currentTab); }
  else if (currentTab === 12) { renderAnnualPage(); }
  else { renderSavingsPage(); }
}

function renderMonthPage(m) {
  var md = getMonthData(m);
  var totalIncome = getTotalIncome(m);
  var totalExpenses = getTotalExpenses(m);
  var annualTotal = getAnnualTotalForMonth(m);
  var savingsAmount = getMonthSavings(m);
  var provision = getAnnualProvisionForMonth(m);
  var provisionTotal = provision.total;
  var balance = totalIncome - totalExpenses - annualTotal - savingsAmount - provisionTotal;
  var totalOut = totalExpenses + annualTotal + provisionTotal;
  var ratio = totalIncome > 0 ? Math.min(100, Math.max(0, (balance / totalIncome) * 100)) : 0;

  var html = '';
  // Summary cards
  html += '<div class="summary-row">';
  html += '<div class="summary-card income"><div class="label">Revenus</div><div class="value">' + fmt(totalIncome) + '</div></div>';
  html += '<div class="summary-card expense"><div class="label">Dépenses</div><div class="value">' + fmt(totalOut) + '</div></div>';
  html += '<div class="summary-card savings-card"><div class="label">Épargne</div><div class="value">' + fmt(savingsAmount) + '</div></div>';
  html += '<div class="summary-card balance"><div class="label">Solde</div><div class="value ' + (balance >= 0 ? 'positive' : 'negative') + '">' + fmt(balance) + '</div>';
  html += '<div class="balance-bar"><div class="balance-bar-fill ' + (balance >= 0 ? 'positive' : 'negative') + '" style="width:' + Math.abs(ratio) + '%"></div></div>';
  html += '</div></div>';

  // Income
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon income-icon"><i class="fas fa-arrow-down"></i></span>Revenus</div>';
  html += '<div class="section-total income-total">' + fmt(totalIncome) + '</div></div>';
  for (var i = 0; i < md.income.length; i++) {
    html += buildEditableRow('income', m, i, md.income[i]);
  }
  html += '<button class="add-row-btn" onclick="addRow(\'income\',' + m + ')"><i class="fas fa-plus"></i> Ajouter un revenu</button>';
  html += '</div>';

  // Expenses
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon expense-icon"><i class="fas fa-arrow-up"></i></span>Dépenses mensuelles</div>';
  html += '<div class="section-total expense-total">' + fmt(totalExpenses) + '</div></div>';
  for (var j = 0; j < md.expenses.length; j++) {
    html += buildEditableRow('expenses', m, j, md.expenses[j]);
  }
  html += '<button class="add-row-btn" onclick="addRow(\'expenses\',' + m + ')"><i class="fas fa-plus"></i> Ajouter une dépense</button>';
  html += '</div>';

  // Provision for annual expenses (AUTO)
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon provision-icon"><i class="fas fa-vault"></i></span>Épargne dép. annuelles<span class="provision-badge">AUTO</span></div>';
  html += '<div class="section-total provision-total">' + fmt(provisionTotal) + '</div></div>';
  if (provision.details.length === 0) {
    html += '<div class="empty-state"><i class="fas fa-check-circle"></i><p>Aucun provisionnement ce mois.<br>Les dépenses annuelles à venir apparaîtront ici.</p></div>';
  } else {
    for (var p = 0; p < provision.details.length; p++) {
      var prov = provision.details[p];
      var remainingMonths = prov.dueMonth - m;
      html += '<div class="budget-row provision-row">';
      html += '<div class="row-label"><div class="provision-detail-label">';
      html += '<span class="prov-name">' + escapeHtml(prov.label) + '</span>';
      html += '<span class="prov-meta">' + fmt(prov.fullAmount) + ' en ' + MONTHS[prov.dueMonth] + ' — encore ' + remainingMonths + ' mois</span>';
      html += '</div></div>';
      html += '<div class="row-amount"><div class="auto-value">' + fmt(prov.monthlyAmount) + '</div></div>';
      html += '<div class="row-delete"></div></div>';
    }
  }
  html += '</div>';

  // Annual auto (expenses due THIS month)
  var annuals = getAnnualForMonth(m);
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-calendar-check"></i></span>Sorties annuelles<span class="auto-badge">AUTO</span></div>';
  html += '<div class="section-total annual-total">' + fmt(annualTotal) + '</div></div>';
  if (annuals.length === 0) {
    html += '<div class="empty-state"><i class="fas fa-calendar-xmark"></i><p>Aucune dépense annuelle prévue ce mois.<br>Ajoutez-en depuis l\'onglet <strong>Annuelles</strong>.</p></div>';
  } else {
    for (var k = 0; k < annuals.length; k++) {
      html += '<div class="budget-row auto-row">';
      html += '<div class="row-label">' + escapeHtml(annuals[k].label) + '</div>';
      html += '<div class="row-amount"><div class="auto-value">' + fmt(annuals[k].amount) + '</div></div>';
      html += '<div class="row-delete"></div></div>';
    }
  }
  html += '</div>';

  // Savings section
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-piggy-bank"></i></span>Épargne du mois</div>';
  html += '<div class="section-total savings-total">' + fmt(savingsAmount) + '</div></div>';
  html += '<div class="savings-inline">';
  html += '<div class="savings-inline-label"><i class="fas fa-coins" style="color:var(--savings)"></i> Montant à épargner</div>';
  html += '<div class="savings-inline-input"><input type="number" inputmode="decimal" value="' + (savingsAmount || '') + '" placeholder="0" ';
  html += 'onfocus="this.select()" onchange="updateSavings(' + m + ',this.value)"></div>';
  html += '</div></div>';

  document.getElementById('mainContent').innerHTML = html;
}

function buildEditableRow(type, m, idx, row) {
  var html = '<div class="budget-row">';
  html += '<div class="row-label"><input type="text" value="' + escapeAttr(row.label) + '" placeholder="Intitulé…" ';
  html += 'onchange="updateLabel(\'' + type + '\',' + m + ',' + idx + ',this.value)"></div>';
  html += '<div class="row-amount"><input type="number" inputmode="decimal" value="' + (row.amount || '') + '" placeholder="0" ';
  html += 'onfocus="this.select()" onchange="updateAmount(\'' + type + '\',' + m + ',' + idx + ',this.value)"></div>';
  html += '<div class="row-delete"><button onclick="deleteRow(\'' + type + '\',' + m + ',' + idx + ')"><i class="fas fa-xmark"></i></button></div>';
  html += '</div>';
  return html;
}

function renderAnnualPage() {
  var annuals = getAnnualExpenses();
  var totalAnnual = annuals.reduce(function(s, a) { return s + (parseFloat(a.amount) || 0); }, 0);
  var monthlyAvg = totalAnnual / 12;
  var perMonth = [];
  var maxMonth = 0;
  for (var mi = 0; mi < 12; mi++) {
    var t = getAnnualTotalForMonth(mi);
    perMonth.push(t);
    if (t > maxMonth) maxMonth = t;
  }
  var totalIncomeYear = 0, totalExpensesYear = 0, totalProvisionYear = 0;
  for (var yi = 0; yi < 12; yi++) {
    totalIncomeYear += getTotalIncome(yi);
    totalExpensesYear += getTotalExpenses(yi);
  }
  // Note: provisions are already part of the monthly deductions for balance display,
  // but for the annual overview the actual annual expenses are what matters
  var yearBalance = totalIncomeYear - totalExpensesYear - totalAnnual - getTotalSavingsYear();

  var html = '';
  html += '<div class="annual-summary">';
  html += '<div class="summary-card"><div class="label">Total annuel</div><div class="value">' + fmt(totalAnnual) + '</div></div>';
  html += '<div class="summary-card"><div class="label">Moyenne / mois</div><div class="value">' + fmt(monthlyAvg) + '</div></div>';
  html += '<div class="summary-card balance"><div class="label">Bilan année</div><div class="value ' + (yearBalance >= 0 ? 'positive' : 'negative') + '">' + fmt(yearBalance) + '</div></div>';
  html += '</div>';

  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-chart-bar"></i></span>Répartition mensuelle</div></div>';
  html += '<div class="annual-month-dist">';
  for (var di = 0; di < 12; di++) {
    var pct = maxMonth > 0 ? (perMonth[di] / maxMonth) * 100 : 0;
    html += '<div class="dist-row">';
    html += '<span class="dist-label">' + MONTHS_SHORT[di] + '</span>';
    html += '<div class="dist-bar"><div class="dist-bar-fill" style="width:' + pct + '%"></div></div>';
    html += '<span class="dist-amount">' + fmt(perMonth[di]) + '</span>';
    html += '</div>';
  }
  html += '</div></div>';

  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon annual-icon"><i class="fas fa-calendar-alt"></i></span>Dépenses annuelles</div>';
  html += '<div class="section-total annual-total">' + fmt(totalAnnual) + '</div></div>';
  if (annuals.length === 0) {
    html += '<div class="empty-state"><i class="fas fa-calendar-plus"></i><p>Aucune dépense annuelle.<br>Ajoutez vos charges annuelles ici.</p></div>';
  } else {
    for (var ai = 0; ai < annuals.length; ai++) {
      html += buildAnnualRow(ai, annuals[ai]);
    }
  }
  html += '<button class="add-row-btn" onclick="addAnnualExpense()"><i class="fas fa-plus"></i> Ajouter une dépense annuelle</button>';
  html += '</div>';

  document.getElementById('mainContent').innerHTML = html;
}

function buildAnnualRow(idx, row) {
  var html = '<div class="annual-row">';
  html += '<div class="row-label"><input type="text" value="' + escapeAttr(row.label) + '" placeholder="Intitulé…" ';
  html += 'onchange="updateAnnualLabel(' + idx + ',this.value)"></div>';
  html += '<div class="row-amount"><input type="number" inputmode="decimal" value="' + (row.amount || '') + '" placeholder="0" ';
  html += 'onfocus="this.select()" onchange="updateAnnualAmount(' + idx + ',this.value)"></div>';
  html += '<div><select class="month-select" onchange="updateAnnualMonth(' + idx + ',this.value)">';
  for (var sm = 0; sm < 12; sm++) {
    var sel = sm === row.month ? ' selected' : '';
    html += '<option value="' + sm + '"' + sel + '>' + MONTHS_SHORT[sm] + '</option>';
  }
  html += '</select></div>';
  html += '<div class="row-delete"><button onclick="deleteAnnualExpense(' + idx + ')"><i class="fas fa-xmark"></i></button></div>';
  html += '</div>';
  return html;
}

// ========== SAVINGS PAGE ==========
function renderSavingsPage() {
  var totalSav = getTotalSavingsYear();
  var goal = getSavingsGoal();
  var avgSav = totalSav / 12;
  var goalPct = goal > 0 ? Math.min(100, (totalSav / goal) * 100) : 0;

  // Per-month savings for chart
  var monthlySavings = [];
  var maxSav = 0;
  for (var si = 0; si < 12; si++) {
    var sv = getMonthSavings(si);
    monthlySavings.push(sv);
    if (sv > maxSav) maxSav = sv;
  }

  var html = '';
  // Summary
  html += '<div class="savings-summary">';
  html += '<div class="summary-card savings-card"><div class="label">Total épargné</div><div class="value">' + fmt(totalSav) + '</div></div>';
  html += '<div class="summary-card savings-card"><div class="label">Moyenne / mois</div><div class="value">' + fmt(avgSav) + '</div></div>';
  if (goal > 0) {
    html += '<div class="summary-card savings-card"><div class="label">Objectif</div><div class="value">' + fmt(goal) + '</div></div>';
  } else {
    html += '<div class="summary-card"><div class="label">Objectif</div><div class="value" style="color:var(--text-muted)">Non défini</div></div>';
  }
  html += '</div>';

  // Goal section
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-bullseye"></i></span>Objectif annuel</div></div>';
  html += '<div class="savings-goal-section">';
  html += '<div class="savings-goal-row">';
  html += '<label for="goalInput">Montant cible :</label>';
  html += '<input type="number" inputmode="decimal" id="goalInput" value="' + (goal || '') + '" placeholder="Ex: 5000" onfocus="this.select()" onchange="updateGoal(this.value)">';
  html += '</div>';
  if (goal > 0) {
    html += '<div class="savings-goal-bar"><div class="savings-goal-fill" style="width:' + goalPct + '%"></div></div>';
    html += '<div class="savings-goal-pct">' + fmt(totalSav) + ' / ' + fmt(goal) + ' — ' + goalPct.toFixed(1) + '%</div>';
  }
  html += '</div></div>';

  // Chart (bar chart via canvas)
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-chart-area"></i></span>Évolution cumulative</div></div>';
  html += '<div class="savings-chart-container"><canvas class="savings-chart-canvas" id="savingsChart"></canvas></div>';
  html += '</div>';

  // Monthly distribution bars
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-chart-bar"></i></span>Épargne par mois</div></div>';
  html += '<div class="annual-month-dist">';
  for (var di = 0; di < 12; di++) {
    var pct = maxSav > 0 ? (monthlySavings[di] / maxSav) * 100 : 0;
    html += '<div class="dist-row">';
    html += '<span class="dist-label">' + MONTHS_SHORT[di] + '</span>';
    html += '<div class="dist-bar"><div class="dist-bar-fill savings-fill" style="width:' + pct + '%"></div></div>';
    html += '<span class="dist-amount">' + fmt(monthlySavings[di]) + '</span>';
    html += '</div>';
  }
  html += '</div></div>';

  // Detailed table
  html += '<div class="section">';
  html += '<div class="section-header"><div class="section-title"><span class="icon savings-icon"><i class="fas fa-list"></i></span>Détail mensuel</div>';
  html += '<div class="section-total savings-total">' + fmt(totalSav) + '</div></div>';
  html += '<div class="savings-table-header"><span></span><span>Mois</span><span style="text-align:right">Épargne</span><span style="text-align:right">Cumul</span></div>';
  for (var ti = 0; ti < 12; ti++) {
    var sVal = getMonthSavings(ti);
    var cumul = getCumulativeSavings(ti);
    var hasVal = sVal > 0 ? ' has-value' : '';
    html += '<div class="savings-table-row' + hasVal + '">';
    html += '<span class="month-label">' + (ti + 1) + '</span>';
    html += '<span class="month-name">' + MONTHS[ti] + '</span>';
    html += '<span class="sav-amount">' + (sVal > 0 ? fmt(sVal) : '—') + '</span>';
    html += '<span class="sav-cumul">' + (cumul > 0 ? fmt(cumul) : '—') + '</span>';
    html += '</div>';
  }
  html += '</div>';

  document.getElementById('mainContent').innerHTML = html;

  // Draw chart after DOM update
  drawSavingsChart(monthlySavings, goal);
}

function drawSavingsChart(monthlySavings, goal) {
  var canvas = document.getElementById('savingsChart');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width;
  var H = rect.height;

  var cumData = [];
  var running = 0;
  for (var i = 0; i < 12; i++) {
    running += monthlySavings[i];
    cumData.push(running);
  }

  var maxVal = Math.max.apply(null, cumData);
  if (goal > 0 && goal > maxVal) maxVal = goal;
  if (maxVal === 0) maxVal = 1;

  var padL = 10, padR = 10, padT = 20, padB = 30;
  var chartW = W - padL - padR;
  var chartH = H - padT - padB;

  var isDark = document.documentElement.classList.contains('dark');
  var gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
  var textColor = isDark ? '#6E6A62' : '#9E9E9E';
  var savingsColor = isDark ? '#4EC4C4' : '#2E8B8B';
  var fillColor = isDark ? 'rgba(78,196,196,0.15)' : 'rgba(46,139,139,0.1)';
  var goalColor = isDark ? 'rgba(110,189,132,0.4)' : 'rgba(90,154,110,0.3)';

  // Grid lines
  ctx.strokeStyle = gridColor;
  ctx.lineWidth = 1;
  for (var g = 0; g <= 4; g++) {
    var gy = padT + (chartH / 4) * g;
    ctx.beginPath();
    ctx.moveTo(padL, gy);
    ctx.lineTo(W - padR, gy);
    ctx.stroke();
  }

  // Goal line
  if (goal > 0) {
    var goalY = padT + chartH - (goal / maxVal) * chartH;
    ctx.strokeStyle = goalColor;
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(padL, goalY);
    ctx.lineTo(W - padR, goalY);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = goalColor;
    ctx.font = '600 11px Nunito';
    ctx.fillText('Objectif', W - padR - 52, goalY - 5);
  }

  // Area fill
  ctx.beginPath();
  for (var a = 0; a < 12; a++) {
    var ax = padL + (a / 11) * chartW;
    var ay = padT + chartH - (cumData[a] / maxVal) * chartH;
    if (a === 0) ctx.moveTo(ax, ay);
    else ctx.lineTo(ax, ay);
  }
  ctx.lineTo(padL + chartW, padT + chartH);
  ctx.lineTo(padL, padT + chartH);
  ctx.closePath();
  ctx.fillStyle = fillColor;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = savingsColor;
  ctx.lineWidth = 3;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  for (var l = 0; l < 12; l++) {
    var lx = padL + (l / 11) * chartW;
    var ly = padT + chartH - (cumData[l] / maxVal) * chartH;
    if (l === 0) ctx.moveTo(lx, ly);
    else ctx.lineTo(lx, ly);
  }
  ctx.stroke();

  // Dots
  for (var d = 0; d < 12; d++) {
    var dx = padL + (d / 11) * chartW;
    var dy = padT + chartH - (cumData[d] / maxVal) * chartH;
    ctx.beginPath();
    ctx.arc(dx, dy, cumData[d] > 0 ? 4 : 2, 0, Math.PI * 2);
    ctx.fillStyle = cumData[d] > 0 ? savingsColor : gridColor;
    ctx.fill();
    if (cumData[d] > 0) {
      ctx.strokeStyle = isDark ? '#2A2A32' : '#FFF';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }

  // Month labels
  ctx.fillStyle = textColor;
  ctx.font = '700 10px Nunito';
  ctx.textAlign = 'center';
  for (var m = 0; m < 12; m++) {
    var mx = padL + (m / 11) * chartW;
    ctx.fillText(MONTHS_SHORT[m], mx, H - 8);
  }
}

// ========== DATA OPERATIONS ==========
function updateLabel(type, m, idx, val) {
  getMonthData(m)[type][idx].label = val;
  saveToStorage(); renderTabs();
}
function updateAmount(type, m, idx, val) {
  getMonthData(m)[type][idx].amount = parseFloat(val) || 0;
  saveToStorage(); renderTabs(); renderContent();
}
function addRow(type, m) {
  getMonthData(m)[type].push({ label: '', amount: 0 });
  saveToStorage(); renderContent();
  var rows = document.querySelectorAll('.section .budget-row .row-label input');
  if (rows.length > 0) rows[rows.length - 1].focus();
}
function deleteRow(type, m, idx) {
  showConfirmDialog('Supprimer cette ligne ?', 'Cette action est irréversible.', function() {
    getMonthData(m)[type].splice(idx, 1);
    saveToStorage(); renderTabs(); renderContent();
  });
}

function updateSavings(m, val) {
  getMonthData(m).savings = parseFloat(val) || 0;
  saveToStorage(); renderTabs(); renderContent();
}

function updateGoal(val) {
  setSavingsGoal(val);
  saveToStorage(); renderContent();
}

function updateAnnualLabel(idx, val) {
  getAnnualExpenses()[idx].label = val;
  saveToStorage();
}
function updateAnnualAmount(idx, val) {
  getAnnualExpenses()[idx].amount = parseFloat(val) || 0;
  saveToStorage(); renderTabs(); renderContent();
}
function updateAnnualMonth(idx, val) {
  getAnnualExpenses()[idx].month = parseInt(val, 10);
  saveToStorage(); renderTabs(); renderContent();
}
function addAnnualExpense() {
  getAnnualExpenses().push({ label: '', amount: 0, month: 0 });
  saveToStorage(); renderContent();
  var rows = document.querySelectorAll('.annual-row .row-label input');
  if (rows.length > 0) rows[rows.length - 1].focus();
}
function deleteAnnualExpense(idx) {
  showConfirmDialog('Supprimer cette dépense annuelle ?', 'Elle sera retirée du mois correspondant.', function() {
    getAnnualExpenses().splice(idx, 1);
    saveToStorage(); renderTabs(); renderContent();
  });
}

// ========== YEAR ==========
function changeYear(delta) {
  currentYear += delta;
  document.getElementById('yearDisplay').textContent = currentYear;
  initYearData(); renderTabs(); renderContent();
}

// ========== EXPORT / IMPORT ==========
function exportData() {
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'budget_' + currentYear + '.json';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  showToast('fa-check-circle', 'Données exportées');
}
function triggerImport() { document.getElementById('fileInput').click(); }
function importData(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var imported = JSON.parse(e.target.result);
      if (typeof imported === 'object' && imported !== null) {
        data = imported;
        var keys = Object.keys(data);
        if (keys.length > 0) {
          currentYear = parseInt(keys[0].substring(1), 10);
          document.getElementById('yearDisplay').textContent = currentYear;
        }
        saveToStorage(); renderTabs(); renderContent();
        showToast('fa-check-circle', 'Données importées avec succès');
      }
    } catch (err) {
      showToast('fa-exclamation-triangle', 'Fichier invalide');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ========== RESET ==========
function showResetConfirm() {
  showConfirmDialog(
    'Réinitialiser toutes les données ?',
    'Toutes les données de l\'année ' + currentYear + ' seront effacées. Cette action est irréversible.',
    function() {
      delete data[getYearKey()];
      initYearData(); saveToStorage(); renderTabs(); renderContent();
      showToast('fa-rotate-left', 'Données réinitialisées');
    }
  );
}

// ========== MODAL ==========
function showConfirmDialog(title, message, onConfirm) {
  var overlay = document.getElementById('modalOverlay');
  var content = document.getElementById('modalContent');
  content.innerHTML = '<h3>' + escapeHtml(title) + '</h3><p>' + escapeHtml(message) + '</p>' +
    '<div class="modal-actions">' +
    '<button class="modal-btn cancel" id="modalCancel">Annuler</button>' +
    '<button class="modal-btn confirm" id="modalConfirm">Confirmer</button></div>';
  overlay.classList.add('show');
  document.getElementById('modalCancel').onclick = function() { overlay.classList.remove('show'); };
  document.getElementById('modalConfirm').onclick = function() { overlay.classList.remove('show'); onConfirm(); };
  overlay.onclick = function(e) { if (e.target === overlay) overlay.classList.remove('show'); };
}

// ========== TOAST ==========
function showToast(icon, message) {
  var toast = document.getElementById('toast');
  toast.querySelector('.toast-icon').className = 'toast-icon fas ' + icon;
  toast.querySelector('.toast-text').textContent = message;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}

// ========== UTILS ==========
function escapeHtml(str) {
  var div = document.createElement('div');
  div.appendChild(document.createTextNode(str));
  return div.innerHTML;
}
function escapeAttr(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ========== INIT ==========
// Try to restore data from storage first
var didLoad = loadFromStorage();
if (didLoad) {
  // Find most recent year in stored data
  var storedKeys = Object.keys(data);
  if (storedKeys.length > 0) {
    var years = storedKeys.map(function(k) { return parseInt(k.substring(1), 10); }).sort();
    currentYear = years[years.length - 1];
    document.getElementById('yearDisplay').textContent = currentYear;
  }
}
initYearData();
renderTabs();
renderContent();
</script>
</body>
</html>
